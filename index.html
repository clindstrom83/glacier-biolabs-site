<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Glacier BioLabs â€” Research Peptides</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="Glacier BioLabs â€” Research Use Only compounds." />
  <style>
    :root{
      --accent:#d0352c;           /* primary red */
      --accent-2:#b12a24;         /* darker red */
      --accent-soft: rgba(208,53,44,.10);
      --ink:#0f172a;
      --muted:#64748b;
      --line:#e5e7eb;
      --bg:#ffffff;
      --card:#ffffff;
      --shadow: 0 10px 25px rgba(2,6,23,.08);
      --radius: 14px;
      --radius-sm: 10px;
      --max: 1180px;

      --topbar-h: 36px;
      --header-h: 72px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:var(--bg);
      color:var(--ink);
    }
    a{color:inherit;text-decoration:none}
    button,input,select,textarea{font:inherit}

    .wrap{max-width:var(--max); margin:0 auto; padding:0 16px}
    .muted{color:var(--muted)}
    .sr-only{position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden}

    /* ===== Topbar + Header ===== */
    .topbar{
      height:var(--topbar-h);
      background:var(--accent-2);
      color:#fff;
      display:flex;
      align-items:center;
      font-size:13px;
    }
    .topbar .wrap{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .topbar .right{
      display:flex; gap:14px; align-items:center;
      opacity:.95;
    }
    .topbar a{color:#fff; opacity:.95}
    .topbar a:hover{opacity:1; text-decoration:underline}

    header{
      position:sticky;
      top:0;
      z-index:50;
      background:#fff;
      border-bottom:1px solid var(--line);
    }
    .header{
      height:var(--header-h);
      display:flex;
      align-items:center;
      gap:14px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 220px;
    }
    .logo{
      height:40px;width:auto; display:block;
    }
    .brand-text{
      display:flex; flex-direction:column; line-height:1.05;
    }
    .brand-text strong{font-size:15px; letter-spacing:.2px}
    .brand-text span{font-size:12px; color:var(--muted)}

    nav.desktop-nav{
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:18px;
      font-weight:600;
      font-size:14px;
    }
    nav.desktop-nav a{
      padding:10px 8px;
      border-radius:10px;
    }
    nav.desktop-nav a:hover{background:rgba(2,6,23,.04)}
    nav.desktop-nav a.active{
      color:var(--accent-2);
      background:var(--accent-soft);
    }

    .search{
      display:flex; align-items:center; gap:0;
      width: 360px;
      max-width: 38vw;
    }
    .search input{
      width:100%;
      border:1px solid var(--line);
      border-right:none;
      padding:11px 12px;
      border-radius:999px 0 0 999px;
      outline:none;
    }
    .search input:focus{
      border-color: rgba(208,53,44,.45);
      box-shadow: 0 0 0 4px rgba(208,53,44,.12);
    }
    .search button{
      border:1px solid var(--line);
      background:var(--accent);
      color:#fff;
      padding:11px 14px;
      border-radius:0 999px 999px 0;
      cursor:pointer;
      font-weight:700;
    }
    .search button:hover{background:var(--accent-2)}

    .header-actions{
      display:flex; align-items:center; gap:10px;
    }

    .cart-pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:999px;
      font-weight:700;
      font-size:13px;
      background:#fff;
      cursor:pointer;
    }
    .cart-pill:hover{box-shadow:0 6px 16px rgba(2,6,23,.08)}

    /* ===== Mobile controls ===== */
    .hamburger{
      display:none;
      border:1px solid var(--line);
      background:#fff;
      border-radius:12px;
      padding:10px 12px;
      cursor:pointer;
    }

    .drawer-backdrop{
      position:fixed; inset:0;
      background:rgba(2,6,23,.55);
      display:none;
      z-index:60;
    }
    .drawer{
      position:fixed; top:0; right:0;
      height:100%;
      width:min(420px, 92vw);
      background:#fff;
      z-index:70;
      transform:translateX(100%);
      transition:transform .25s ease;
      display:flex;
      flex-direction:column;
    }
    .drawer.open{transform:translateX(0)}
    .drawer .head{
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between;
    }
    .drawer .body{padding:16px; display:flex; flex-direction:column; gap:8px}
    .drawer .body a{
      padding:12px 12px;
      border:1px solid var(--line);
      border-radius:12px;
      font-weight:700;
    }
    .drawer .body a:hover{background:rgba(2,6,23,.03)}
    .drawer .close{
      border:1px solid var(--line);
      background:#fff;
      border-radius:12px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:800;
    }

    /* ===== Product cards ===== */
    .grid{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap:18px;
    }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      overflow:hidden;
      transition:transform .14s ease, box-shadow .14s ease;
    }
    .card:hover{
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }
    .card .img-wrap{
      position:relative;
      background:#fff;
      border-bottom:1px solid var(--line);
      padding:12px;
    }
    .card .img-topbar{
      position:absolute; left:0; top:0; right:0;
      height:6px;
      background:var(--accent);
      opacity:.95;
    }
    .card img{
      width:100%;
      height:170px;
      object-fit:contain;
      background:#fff;
      border-radius:12px;
      display:block;
    }
    .card .body{
      padding:14px 14px 16px;
    }
    .card h3{
      margin:0;
      font-size:15px;
      line-height:1.25;
      letter-spacing:.2px;
      min-height: 38px;
    }
    .card .actions{
      margin-top:12px;
      display:flex; gap:8px; justify-content:space-between;
    }
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      gap:10px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid transparent;
      font-weight:800;
      cursor:pointer;
      white-space:nowrap;
    }
    .btn.small{padding:8px 10px;font-size:13px}
    .btn.primary{
      background:var(--accent);
      color:#fff;
      box-shadow:0 14px 30px rgba(208,53,44,.28);
    }
    .btn.ghost{
      background:transparent;
      border-color:rgba(2,6,23,.08);
      color:var(--ink);
    }

    /* Cart drawer (simple) */
    .cart-drawer{
      position:fixed; right:18px; top:88px; width:320px; max-width:92vw;
      background:#fff; border:1px solid var(--line); border-radius:12px; box-shadow:var(--shadow);
      z-index:80; padding:12px; display:none; flex-direction:column; gap:8px;
    }
    .cart-drawer.open{display:flex}
    .cart-item{display:flex; gap:10px; align-items:center; justify-content:space-between}
    .cart-item .meta{flex:1}
    .cart-item .meta h4{margin:0;font-size:14px}
    .cart-item .meta p{margin:4px 0 0;font-size:13px;color:var(--muted)}
    .cart-total{font-weight:900;text-align:right;margin-top:8px}
    .cart-empty{color:var(--muted);text-align:center;padding:14px 0}

    /* Responsive */
    @media (max-width: 1100px){
      .grid{grid-template-columns: repeat(3, minmax(0,1fr))}
    }
    @media (max-width: 900px){
      .search{display:none}
      nav.desktop-nav{display:none}
      .hamburger{display:inline-flex}
      .brand{min-width: unset}
      .grid{grid-template-columns: repeat(2, minmax(0,1fr))}
    }
    @media (max-width: 430px){
      .grid{gap:14px}
      .card img{height:150px}
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="wrap">
      <div>support@glacierbiolabs.com</div>
      <div class="right">
        <a href="#/shop">Shop</a>
        <a href="#/account">My Account</a>
      </div>
    </div>
  </div>

  <header>
    <div class="wrap header">
      <button type="button" class="hamburger" id="open-drawer" aria-label="Open menu" aria-expanded="false">â˜°</button>

      <a class="brand" href="#/">
        <img id="site-logo" class="logo" src="" alt="Glacier BioLabs" onerror="this.style.display='none'">
        <div class="brand-text">
          <strong>Glacier BioLabs</strong>
          <span>Research Use Only</span>
        </div>
      </a>

      <nav class="desktop-nav" aria-label="Main navigation" id="desktop-nav">
        <a href="#/shop" data-nav="shop">BUY PEPTIDES</a>
        <a href="#/learn" data-nav="learn">ABOUT</a>
        <a href="#/knowledge" data-nav="knowledge">KNOWLEDGE</a>
        <a href="#/faq" data-nav="contact">CONTACT</a>
      </nav>

      <form class="search" id="search-form">
        <label class="sr-only" for="q">Search</label>
        <input id="q" type="search" placeholder="Search products..." autocomplete="off">
        <button type="submit" aria-label="Search">ðŸ”Ž</button>
      </form>

      <div class="header-actions">
        <a class="pill" href="#/shop" title="Browse products">Shop</a>
        <button type="button" id="cart-toggle" class="cart-pill" aria-label="Open cart">
          Cart <span id="cart-count" style="background:var(--accent);color:#fff;padding:4px 8px;border-radius:999px;font-weight:900;margin-left:6px">0</span>
        </button>
      </div>
    </div>
  </header>

  <!-- Mobile drawer -->
  <div class="drawer-backdrop" id="drawer-backdrop"></div>
  <aside class="drawer" id="drawer" aria-hidden="true">
    <div class="head">
      <strong>Menu</strong>
      <button type="button" class="close" id="close-drawer" aria-label="Close menu">âœ•</button>
    </div>
    <div class="body">
      <a href="#/shop">BUY PEPTIDES</a>
      <a href="#/learn">ABOUT</a>
      <a href="#/knowledge">KNOWLEDGE</a>
      <a href="#/faq">CONTACT</a>
      <a href="#/account">MY ACCOUNT</a>
    </div>
  </aside>

  <!-- Simple cart drawer -->
  <div id="cart-drawer" class="cart-drawer" aria-hidden="true">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <strong>Your Cart</strong>
      <button type="button" id="close-cart" style="border:1px solid var(--line);background:#fff;border-radius:10px;padding:6px 8px;cursor:pointer">Close</button>
    </div>
    <div id="cart-contents"></div>
    <div id="cart-footer" style="margin-top:8px">
      <div class="cart-total" id="cart-total"></div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="checkout-from-cart" class="btn primary" style="flex:1" type="button">Checkout (Buy Now per item)</button>
        <button id="clear-cart" class="btn" style="border:1px solid var(--line);background:#fff" type="button">Clear</button>
      </div>
      <div style="font-size:12px;color:var(--muted);margin-top:8px">Use individual product "Buy Now" for single-item quick checkout. Cart checkout will open product pages for each item to complete payment (simplified flow).</div>
    </div>
  </div>

  <main id="app" class="wrap" style="padding:20px"></main>

  <section class="newsletter">
    <div class="wrap">
      <div>
        <h3>SUBSCRIBE TO OUR NEWSLETTER</h3>
        <p>Get promotions and updates sent to your inbox.</p>
      </div>
      <form class="nl-form" id="nl-form">
        <input placeholder="First Name" name="first" />
        <input placeholder="Last Name" name="last" />
        <input class="wide" placeholder="Email" name="email" type="email" required />
        <input class="wide" placeholder="Phone (optional)" name="phone" />
        <button type="submit">SUBSCRIBE</button>
      </form>
    </div>
  </section>

  <footer>
    <div class="wrap">
      Â© <span id="year"></span> Glacier BioLabs â€” Research Use Only â€” Not for human or veterinary use.
    </div>
  </footer>

  <!-- Stripe.js -->
  <script src="https://js.stripe.com/v3/"></script>

  <script>
  // ===== Basic Stripe setup: expects server endpoints:
  // GET  /config                -> { publishableKey }
  // POST /create-checkout-session -> { sessionId }
  // (Server must hold the secret key; do not put secret keys here.)
  let stripe = null;
  let stripeReady = false;

  async function loadStripeKey(){
    try {
      const r = await fetch('/config');
      if (!r.ok) return;
      const data = await r.json();
      if (data && data.publishableKey) {
        stripe = Stripe(data.publishableKey);
        stripeReady = true;
      }
    } catch (err) {
      console.warn('Could not load Stripe publishable key:', err);
    }
  }

  // ===== Products (your data) =====
  const IMAGE_DIR = 'images/';
  const IMAGE_FILES = {
    logo: 'logo.png',
    retatrutide: 'retatrutide-10mg.png',
    ghk: 'ghk-cu-50mg.png',
    mt2: 'mt2-10mg.png',
    bpc: 'bpc-157-10mg.png',
    water: 'bacteriostatic-water-10ml.png'
  };

  const PRODUCTS = [
    { slug: 'retatrutide', name: 'Retatrutide (10 mg)', price: 8500, category: 'Peptides', inStock: true, image: IMAGE_FILES.retatrutide, short: 'High-purity compound supplied for controlled laboratory research.', long: 'Retatrutide is supplied as a lyophilized research compound intended exclusively for laboratory, analytical, and scientific investigation. This listing is for research use only (RUO).', sale: true },
    { slug: 'ghk-cu', name: 'GHK-Cu (Copper Peptide) â€“ 50 mg', price: 4500, category: 'Peptides', inStock: true, image: IMAGE_FILES.ghk, short: 'Copper-binding peptide used in research models of skin and tissue biology.', long: 'GHK-Cu is supplied as a research compound intended for laboratory use only.', sale: true },
    { slug: 'melanotan-ii', name: 'Melanotan II (10 mg)', price: 4000, category: 'Peptides', inStock: true, image: IMAGE_FILES.mt2, short: 'Research analog used to study melanocortin receptor pathways.', long: 'Melanotan II is supplied as a lyophilized research compound. Research use only.', sale: true },
    { slug: 'bpc-157', name: 'BPC-157 (10 mg)', price: 5500, category: 'Peptides', inStock: true, image: IMAGE_FILES.bpc, short: 'Peptide fragment used in controlled research models.', long: 'BPC-157 is provided strictly as a research compound. Not for human or veterinary use.', sale: false },
    { slug: 'water', name: 'Bacteriostatic Water (10 mL)', price: 1000, category: 'Supplies', inStock: true, image: IMAGE_FILES.water, short: 'Sterile diluent typically used for laboratory reconstitution workflows.', long: 'Bacteriostatic water is a sterile solution supplied for laboratory handling and reconstitution workflows.', sale: false }
  ];

  // ===== Helpers =====
  const PLACEHOLDER = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(
    '<svg xmlns="http://www.w3.org/2000/svg" width="900" height="650"><rect width="100%" height="100%" fill="#ffffff"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#94a3b8" font-family="Arial" font-size="18">Image not available</text></svg>'
  );
  const imgPath = (f) => IMAGE_DIR + f;
  const money = (cents) => '$' + (cents/100).toFixed(2);
  const escapeHtml = (str) => String(str ?? '')
    .replace(/&/g,'&amp;').replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;').replace(/'/g,'&#39;');

  // ===== Cart (localStorage) =====
  const CART_KEY = 'glacier_cart_v1';
  function readCart(){
    try { return JSON.parse(localStorage.getItem(CART_KEY) || '[]'); }
    catch(e){ return []; }
  }
  function writeCart(cart){ localStorage.setItem(CART_KEY, JSON.stringify(cart)); updateCartUI(); }
  function addToCart(slug, qty = 1){
    const cart = readCart();
    const idx = cart.findIndex(c => c.slug === slug);
    if (idx === -1) cart.push({ slug, qty: qty });
    else cart[idx].qty = (cart[idx].qty || 0) + qty;
    writeCart(cart);
  }
  function removeFromCart(slug){
    const cart = readCart().filter(i => i.slug !== slug);
    writeCart(cart);
  }
  function setQty(slug, qty){
    const cart = readCart();
    const idx = cart.findIndex(c => c.slug === slug);
    if (idx === -1) return;
    cart[idx].qty = Math.max(1, qty);
    writeCart(cart);
  }
  function clearCart(){ writeCart([]); }

  function cartCount(){
    return readCart().reduce((s,i)=>s+(i.qty||0),0);
  }
  function cartTotal(){
    const cart = readCart();
    return cart.reduce((sum, item) => {
      const p = PRODUCTS.find(x => x.slug === item.slug);
      return sum + (p ? p.price * (item.qty || 0) : 0);
    }, 0);
  }

  function updateCartUI(){
    const countEl = document.getElementById('cart-count');
    if (countEl) countEl.textContent = String(cartCount());
    const contents = document.getElementById('cart-contents');
    const total = document.getElementById('cart-total');
    if (!contents || !total) return;
    const cart = readCart();
    if (cart.length === 0){
      contents.innerHTML = '<div class="cart-empty">Your cart is empty.</div>';
      total.textContent = '';
      return;
    }
    contents.innerHTML = cart.map(item => {
      const p = PRODUCTS.find(x=>x.slug===item.slug) || { name: item.slug, price:0 };
      return `<div class="cart-item" data-slug="${escapeHtml(item.slug)}">
        <div class="meta">
          <h4>${escapeHtml(p.name)}</h4>
          <p>${money(p.price)} Ã— <input class="qty-input" type="number" min="1" value="${escapeHtml(String(item.qty))}" style="width:60px;padding:6px;border-radius:8px;border:1px solid var(--line)"></p>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
          <div style="font-weight:900">${money((p.price||0)*(item.qty||0))}</div>
          <button class="btn ghost small remove-item" type="button">Remove</button>
        </div>
      </div>`;
    }).join('');
    total.textContent = 'Total: ' + money(cartTotal());
    // wire quantity inputs & remove buttons
    contents.querySelectorAll('.cart-item').forEach(el => {
      const slug = el.getAttribute('data-slug');
      const qtyInput = el.querySelector('.qty-input');
      const removeBtn = el.querySelector('.remove-item');
      if (qtyInput){
        qtyInput.addEventListener('change', () => {
          const val = Number(qtyInput.value || 1);
          if (isNaN(val) || val < 1) { qtyInput.value = '1'; setQty(slug,1); }
          else setQty(slug, Math.floor(val));
        });
      }
      if (removeBtn){
        removeBtn.addEventListener('click', () => removeFromCart(slug));
      }
    });
  }

  // ===== Product card html with Add to Cart & Buy Now buttons =====
  function productCardHTML(p){
    const img = imgPath(p.image);
    const stockText = p.inStock ? 'In Stock' : 'Out of Stock';
    return `
      <article class="card" data-slug="${escapeHtml(p.slug)}">
        <a href="#/product/${encodeURIComponent(p.slug)}" aria-label="${escapeHtml(p.name)}">
          <div class="img-wrap">
            <div class="img-topbar"></div>
            ${p.sale ? `<div class="tag-sale">SALE</div>` : ``}
            <img src="${escapeHtml(img)}" alt="${escapeHtml(p.name)}" onerror="this.onerror=null;this.src='${PLACEHOLDER}'">
          </div>
        </a>
        <div class="body">
          <h3>${escapeHtml(p.name)}</h3>
          <div class="price">${money(p.price)}</div>
          <div class="small">${escapeHtml(p.short || '')}</div>
          <div class="small" style="text-align:center;margin-top:10px;font-weight:900;color:${p.inStock ? 'var(--accent-2)' : 'var(--muted)'}">${stockText}</div>
          <div class="actions">
            <button class="btn ghost small add-to-cart" data-slug="${escapeHtml(p.slug)}" type="button">ADD TO CART</button>
            <button class="btn primary small buy-now" data-slug="${escapeHtml(p.slug)}" type="button">${p.inStock ? 'BUY NOW' : 'OUT OF STOCK'}</button>
          </div>
        </div>
      </article>
    `;
  }

  // ===== Views (minimal) =====
  function renderShop(app) {
    app.innerHTML = `
      <section class="section">
        <h2>Shop All Products</h2>
        <div class="grid">${PRODUCTS.map(p => productCardHTML(p)).join('')}</div>
      </section>
    `;
    // wire Add to Cart and Buy Now buttons (delegation)
    document.querySelectorAll('.add-to-cart').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const slug = btn.getAttribute('data-slug');
        addToCart(slug, 1);
      });
    });
    document.querySelectorAll('.buy-now').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const slug = btn.getAttribute('data-slug');
        buyNow(slug, 1);
      });
    });
  }

  function renderProduct(app, slug){
    const p = PRODUCTS.find(x => x.slug === slug);
    if (!p) {
      app.innerHTML = `<div class="page"><h1>Product not found</h1><a class="btn primary" href="#/shop">Back to shop</a></div>`;
      return;
    }
    app.innerHTML = `
      <section class="section">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:18px">
          <div>
            <img src="${escapeHtml(imgPath(p.image))}" alt="${escapeHtml(p.name)}" onerror="this.onerror=null;this.src='${PLACEHOLDER}'" style="width:100%;height:360px;object-fit:contain;border:1px solid var(--line);border-radius:12px;padding:12px;background:#fff">
          </div>
          <div>
            <h1>${escapeHtml(p.name)}</h1>
            <div class="big-price" style="font-size:24px;font-weight:900;color:var(--accent-2)">${money(p.price)}</div>
            <p class="desc">${escapeHtml(p.long)}</p>
            <div style="display:flex;gap:8px;margin-top:12px">
              <button class="btn ghost" id="add-to-cart-detail" type="button">ADD TO CART</button>
              <button class="btn primary" id="buy-now-detail" type="button">BUY NOW</button>
            </div>
          </div>
        </div>
      </section>
    `;
    document.getElementById('add-to-cart-detail').addEventListener('click', () => {
      addToCart(p.slug, 1);
    });
    document.getElementById('buy-now-detail').addEventListener('click', () => buyNow(p.slug, 1));
  }

  // ===== Buy Now / Checkout for single item =====
  async function buyNow(slug, qty = 1){
    if (!stripeReady){
      alert('Payment system not ready. Make sure your server exposes /config with your Stripe publishable key.');
      return;
    }
    // For a single-item checkout we post { slug, qty, email } to /create-checkout-session
    // Prompt user for an email minimally
    const email = prompt('Enter your email for receipt:');
    if (!email) { alert('Email required to proceed'); return; }

    try {
      const res = await fetch('/create-checkout-session', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({
          slug, qty, email,
          successUrl: window.location.origin + '/?checkout=success',
          cancelUrl: window.location.href
        })
      });
      const data = await res.json();
      if (!res.ok) {
        console.error('create-checkout-session failed', data);
        alert(data?.message || 'Could not create checkout session');
        return;
      }
      if (!data.sessionId) { alert('No sessionId returned from server'); return; }
      const { error } = await stripe.redirectToCheckout({ sessionId: data.sessionId });
      if (error) {
        console.error(error);
        alert('Stripe redirect failed: ' + (error.message || 'unknown'));
      }
    } catch (err) {
      console.error(err);
      alert('Unexpected error creating checkout session');
    }
  }

  // ===== Small router =====
  function route(){
    const app = document.getElementById('app');
    const hash = location.hash || '#/';
    if (hash.startsWith('#/product/')) {
      const slug = decodeURIComponent(hash.split('#/product/')[1] || '');
      renderProduct(app, slug);
    } else {
      renderShop(app);
    }
    updateCartUI();
  }

  // ===== UI wiring (cart, drawer, brand) =====
  document.addEventListener('DOMContentLoaded', async () => {
    await loadStripeKey();
    const logo = document.getElementById('site-logo');
    if (logo) logo.src = imgPath(IMAGE_FILES.logo);
    const year = document.getElementById('year');
    if (year) year.textContent = String(new Date().getFullYear());

    // drawer (mobile)
    const drawer = document.getElementById('drawer');
    const backdrop = document.getElementById('drawer-backdrop');
    const openBtn = document.getElementById('open-drawer');
    const closeBtn = document.getElementById('close-drawer');
    function open(){ if(!drawer||!backdrop||!openBtn) return; drawer.classList.add('open'); backdrop.style.display='block'; drawer.setAttribute('aria-hidden','false'); openBtn.setAttribute('aria-expanded','true'); }
    function close(){ if(!drawer||!backdrop||!openBtn) return; drawer.classList.remove('open'); backdrop.style.display='none'; drawer.setAttribute('aria-hidden','true'); openBtn.setAttribute('aria-expanded','false'); }
    if (openBtn) openBtn.addEventListener('click', open);
    if (closeBtn) closeBtn.addEventListener('click', close);
    if (backdrop) backdrop.addEventListener('click', close);
    document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape'){ close(); closeCart(); } });

    // cart toggle
    const cartToggle = document.getElementById('cart-toggle');
    const cartDrawer = document.getElementById('cart-drawer');
    const closeCartBtn = document.getElementById('close-cart');
    function openCart(){ if (cartDrawer) { cartDrawer.classList.add('open'); cartDrawer.setAttribute('aria-hidden','false'); updateCartUI(); } }
    function closeCart(){ if (cartDrawer) { cartDrawer.classList.remove('open'); cartDrawer.setAttribute('aria-hidden','true'); } }
    if (cartToggle) cartToggle.addEventListener('click', openCart);
    if (closeCartBtn) closeCartBtn.addEventListener('click', closeCart);

    // cart footer buttons
    const clearBtn = document.getElementById('clear-cart');
    if (clearBtn) clearBtn.addEventListener('click', () => { if (confirm('Clear cart?')) clearCart(); });

    // Checkout from cart: simplified behavior:
    // - If cart has exactly 1 item, trigger buyNow for that item.
    // - If cart has multiple items, open each product page for checkout (simplified - you can request multi-item server support later).
    const checkoutFromCart = document.getElementById('checkout-from-cart');
    if (checkoutFromCart) checkoutFromCart.addEventListener('click', () => {
      const cart = readCart();
      if (cart.length === 0) { alert('Cart is empty'); return; }
      if (!stripeReady) { alert('Payment not ready. Ensure /config is available on server.'); return; }
      if (cart.length === 1) {
        buyNow(cart[0].slug, cart[0].qty || 1);
      } else {
        // Simple fallback: open product pages in new tabs for each item so user can buy individually
        if (confirm('Cart checkout for multiple different items is not enabled. Open product pages to checkout items individually?')) {
          cart.forEach(item => window.open(window.location.origin + '/#/product/' + encodeURIComponent(item.slug), '_blank'));
        }
      }
    });

    // router
    window.addEventListener('hashchange', route);
    if (!location.hash) location.hash = '#/';
    route();
  });
  </script>
</body>
</html>