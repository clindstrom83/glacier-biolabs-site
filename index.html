<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Glacier BioLabs ‚Äî Research Peptides</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="Glacier BioLabs ‚Äî Research Use Only compounds." />
  <style>
    :root{
      --accent:#d0352c;           /* primary red */
      --accent-2:#b12a24;         /* darker red */
      --accent-soft: rgba(208,53,44,.10);
      --ink:#0f172a;
      --muted:#64748b;
      --line:#e5e7eb;
      --bg:#ffffff;
      --card:#ffffff;
      --shadow: 0 10px 25px rgba(2,6,23,.08);
      --radius: 14px;
      --radius-sm: 10px;
      --max: 1180px;

      --topbar-h: 36px;
      --header-h: 72px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:var(--bg);
      color:var(--ink);
    }
    a{color:inherit;text-decoration:none}
    button,input,select,textarea{font:inherit}

    .wrap{max-width:var(--max); margin:0 auto; padding:0 16px}
    .muted{color:var(--muted)}
    .sr-only{position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden}

    /* ===== Topbar + Header ===== */
    .topbar{
      height:var(--topbar-h);
      background:var(--accent-2);
      color:#fff;
      display:flex;
      align-items:center;
      font-size:13px;
    }
    .topbar .wrap{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .topbar .right{
      display:flex; gap:14px; align-items:center;
      opacity:.95;
    }
    .topbar a{color:#fff; opacity:.95}
    .topbar a:hover{opacity:1; text-decoration:underline}

    header{
      position:sticky;
      top:0;
      z-index:50;
      background:#fff;
      border-bottom:1px solid var(--line);
    }
    .header{
      height:var(--header-h);
      display:flex;
      align-items:center;
      gap:14px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 220px;
    }
    .logo{
      height:40px;width:auto; display:block;
    }
    .brand-text{
      display:flex; flex-direction:column; line-height:1.05;
    }
    .brand-text strong{font-size:15px; letter-spacing:.2px}
    .brand-text span{font-size:12px; color:var(--muted)}

    nav.desktop-nav{
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:18px;
      font-weight:600;
      font-size:14px;
    }
    nav.desktop-nav a{
      padding:10px 8px;
      border-radius:10px;
    }
    nav.desktop-nav a:hover{background:rgba(2,6,23,.04)}
    nav.desktop-nav a.active{
      color:var(--accent-2);
      background:var(--accent-soft);
    }

    .search{
      display:flex; align-items:center; gap:0;
      width: 360px;
      max-width: 38vw;
    }
    .search input{
      width:100%;
      border:1px solid var(--line);
      border-right:none;
      padding:11px 12px;
      border-radius:999px 0 0 999px;
      outline:none;
    }
    .search input:focus{
      border-color: rgba(208,53,44,.45);
      box-shadow: 0 0 0 4px rgba(208,53,44,.12);
    }
    .search button{
      border:1px solid var(--line);
      background:var(--accent);
      color:#fff;
      padding:11px 14px;
      border-radius:0 999px 999px 0;
      cursor:pointer;
      font-weight:700;
    }
    .search button:hover{background:var(--accent-2)}

    .header-actions{
      display:flex; align-items:center; gap:10px;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:999px;
      font-weight:700;
      font-size:13px;
      background:#fff;
      cursor:pointer;
    }
    .pill:hover{box-shadow:0 6px 16px rgba(2,6,23,.08)}

    /* ===== Mobile controls ===== */
    .hamburger{
      display:none;
      border:1px solid var(--line);
      background:#fff;
      border-radius:12px;
      padding:10px 12px;
      cursor:pointer;
    }

    .drawer-backdrop{
      position:fixed; inset:0;
      background:rgba(2,6,23,.55);
      display:none;
      z-index:60;
    }
    .drawer{
      position:fixed; top:0; right:0;
      height:100%;
      width:min(420px, 92vw);
      background:#fff;
      z-index:70;
      transform:translateX(100%);
      transition:transform .25s ease;
      display:flex;
      flex-direction:column;
    }
    .drawer.open{transform:translateX(0)}
    .drawer .head{
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between;
    }
    .drawer .body{padding:16px; display:flex; flex-direction:column; gap:8px}
    .drawer .body a{
      padding:12px 12px;
      border:1px solid var(--line);
      border-radius:12px;
      font-weight:700;
    }
    .drawer .body a:hover{background:rgba(2,6,23,.03)}
    .drawer .close{
      border:1px solid var(--line);
      background:#fff;
      border-radius:12px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:800;
    }

    /* ===== Hero ===== */
    .hero{
      position:relative;
      overflow:hidden;
      border-bottom:1px solid var(--line);
      background:
        radial-gradient(1200px 500px at 20% 30%, rgba(208,53,44,.35), transparent 55%),
        radial-gradient(1000px 500px at 75% 30%, rgba(2,6,23,.18), transparent 60%),
        linear-gradient(135deg, rgba(2,6,23,.75), rgba(2,6,23,.45));
    }
    .hero::before{
      content:"";
      position:absolute; inset:0;
      background:
        url("images/hero.jpg") center/cover no-repeat;
      opacity:.22;
      filter:saturate(1.1) contrast(1.05);
    }
    .hero .wrap{
      position:relative;
      padding:56px 16px 48px;
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      align-items:center;
      gap:26px;
    }
    .hero h1{
      margin:0;
      color:#fff;
      font-size:42px;
      letter-spacing:.4px;
    }
    .hero p{
      margin:10px 0 0;
      color:rgba(255,255,255,.88);
      font-size:16px;
      max-width: 56ch;
      line-height:1.45;
    }
    .hero .kicker{
      display:inline-flex;
      gap:10px; align-items:center;
      color:rgba(255,255,255,.85);
      font-weight:800;
      letter-spacing:.18em;
      text-transform:uppercase;
      font-size:12px;
      margin-bottom:10px;
    }
    .hero .cta-row{
      margin-top:18px;
      display:flex; gap:12px; flex-wrap:wrap;
      align-items:center;
    }
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      gap:10px;
      padding:12px 16px;
      border-radius:999px;
      border:1px solid transparent;
      font-weight:800;
      cursor:pointer;
      white-space:nowrap;
    }
    .btn.primary{
      background:var(--accent);
      color:#fff;
      box-shadow:0 14px 30px rgba(208,53,44,.28);
    }
    .btn.primary:hover{background:var(--accent-2)}
    .btn.ghost{
      background:transparent;
      border-color:rgba(255,255,255,.25);
      color:#fff;
    }
    .btn.ghost:hover{background:rgba(255,255,255,.08)}
    .hero .badge{
      display:inline-flex;
      align-items:center;
      padding:10px 12px;
      border-radius:999px;
      background:rgba(255,255,255,.12);
      color:#fff;
      border:1px solid rgba(255,255,255,.18);
      font-weight:700;
      margin-top:14px;
    }
    .hero .panel{
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.14);
      border-radius: var(--radius);
      padding:16px;
      backdrop-filter: blur(6px);
      color:#fff;
    }
    .hero .panel strong{display:block; font-size:14px; letter-spacing:.2px}
    .hero .panel small{display:block; opacity:.88; margin-top:6px; line-height:1.35}

    /* ===== Page sections ===== */
    main{padding:24px 0 0}
    .section{padding:26px 0}
    .section h2{
      margin:0 0 14px;
      font-size:26px;
      letter-spacing:.3px;
    }
    .subhead{
      margin:-8px 0 18px;
      color:var(--muted);
      line-height:1.45;
      max-width: 70ch;
    }
    .divider{height:1px; background:var(--line); margin:20px 0}

    /* ===== Catalog layout ===== */
    .catalog{
      display:grid;
      grid-template-columns: 280px 1fr;
      gap:26px;
      align-items:start;
    }
    aside.filters{
      border-right:1px solid var(--line);
      padding-right:18px;
    }
    .filter-block{padding:6px 0 16px}
    .filter-block h3{
      margin:0 0 10px;
      font-size:16px;
      letter-spacing:.2px;
    }
    .filter-line{height:1px; background:var(--line); margin:10px 0 14px}
    .check{
      display:flex; align-items:center; gap:10px;
      padding:10px 0;
      cursor:pointer;
      user-select:none;
      font-weight:600;
      color:var(--ink);
    }
    .check input{width:18px;height:18px}
    .chip{
      display:inline-flex; align-items:center;
      font-size:12px;
      font-weight:800;
      border-radius:999px;
      padding:4px 8px;
      background:rgba(2,6,23,.05);
      margin-left:auto;
      color:var(--muted);
    }
    .price-range{
      display:flex; gap:10px; align-items:center;
      flex-wrap:wrap;
    }
    .price-range input{
      width:120px;
      padding:10px 10px;
      border:1px solid var(--line);
      border-radius:12px;
    }
    .price-range button{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      font-weight:800;
      cursor:pointer;
    }
    .price-range button:hover{box-shadow:0 10px 22px rgba(2,6,23,.08)}

    .catalog-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:12px;
    }
    .catalog-head .count{
      font-weight:700;
      color:var(--muted);
    }
    .sort{
      display:flex; align-items:center; gap:10px;
    }
    .sort select{
      padding:10px 10px;
      border:1px solid var(--line);
      border-radius:12px;
      background:#fff;
      font-weight:700;
    }

    /* ===== Product cards ===== */
    .grid{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap:18px;
    }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      overflow:hidden;
      transition:transform .14s ease, box-shadow .14s ease;
    }
    .card:hover{
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }
    .card .img-wrap{
      position:relative;
      background:#fff;
      border-bottom:1px solid var(--line);
      padding:12px;
    }
    .card .img-topbar{
      position:absolute; left:0; top:0; right:0;
      height:6px;
      background:var(--accent);
      opacity:.95;
    }
    .card img{
      width:100%;
      height:170px;
      object-fit:contain;
      background:#fff;
      border-radius:12px;
      display:block;
    }
    .tag-sale{
      position:absolute;
      left:12px; top:14px;
      background:var(--accent);
      color:#fff;
      font-weight:900;
      font-size:12px;
      padding:8px 10px;
      border-radius:12px;
      box-shadow:0 12px 24px rgba(208,53,44,.25);
    }
    .card .body{
      padding:14px 14px 16px;
    }
    .card h3{
      margin:0;
      font-size:15px;
      line-height:1.25;
      letter-spacing:.2px;
      min-height: 38px;
    }
    .stars{
      display:flex; align-items:center; justify-content:center;
      gap:2px;
      margin:10px 0 6px;
      color: var(--accent-2);
      font-weight:900;
      font-size:12px;
      letter-spacing:.05em;
    }
    .price{
      text-align:center;
      font-weight:900;
      color: var(--accent-2);
      margin:6px 0 10px;
      font-size:15px;
    }
    .card .small{
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
      min-height: 36px;
    }
    .card .actions{
      margin-top:12px;
      display:flex; justify-content:space-between; gap:8px;
    }

    /* ===== Product detail page ===== */
    .crumbs{
      font-size:13px;
      color:var(--muted);
      margin:6px 0 16px;
    }
    /* New product layout to match requested look */
    .product-page{
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:36px;
      align-items:start;
      padding-bottom: 12px;
    }
    .media{
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding:18px;
      background:#fff;
      box-shadow:var(--shadow);
    }
    .media .img-topbar{height:6px;background:var(--accent);border-radius:999px;margin-bottom:12px}
    .media img{
      width:100%;
      height:420px;
      object-fit:contain;
      display:block;
      background:#fff;
      border-radius:12px;
    }
    .thumb-row{display:flex;gap:10px;margin-top:12px}
    .thumb{width:64px;height:64px;border-radius:10px;border:1px solid var(--line);display:flex;align-items:center;justify-content:center;background:#fff;cursor:pointer;overflow:hidden}
    .thumb img{width:100%;height:100%;object-fit:contain}

    .pinfo h1{margin:0; font-size:22px; letter-spacing:.3px}
    .pinfo .rating-row{display:flex;align-items:center;gap:10px;margin:10px 0;color:var(--muted);font-weight:700}
    .pinfo .price-row{display:flex;align-items:center;gap:12px;margin-top:8px}
    .price-row .old{color:var(--muted);text-decoration:line-through}
    .price-row .now{color:var(--accent-2);font-weight:900;font-size:20px}

    .pinfo .desc{color:var(--muted);line-height:1.6}
    .ruo{margin-top:10px;padding:8px 10px;border-radius:10px;background:var(--accent-soft);border:1px solid rgba(208,53,44,.12);color:var(--accent-2);font-weight:800}

    .add-to-cart-btn{display:inline-flex;align-items:center;justify-content:center;padding:12px 16px;border-radius:10px;border:none;color:#fff;background:linear-gradient(90deg,#1fb6ff,#6f6ff0);font-weight:900;cursor:pointer;width:100%;box-shadow:0 10px 30px rgba(31,182,255,.12)}
    .buy-now-btn{display:inline-flex;align-items:center;justify-content:center;padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer;width:100%}

    .product-sections{margin-top:22px;color:var(--muted);line-height:1.6}
    .product-sections h3{margin:18px 0 8px;color:var(--ink);font-size:15px}
    .product-sections p{margin:0 0 12px}

    /* ===== Trust icons section ===== */
    .trust{
      border-top:1px solid var(--line);
      border-bottom:1px solid var(--line);
      background:#fff;
    }

    /* ===== Newsletter/footer block ===== */
    .newsletter{
      margin-top:28px;
      background:#0b0f19;
      color:#fff;
      padding:34px 0;
    }

    /* ===== Cart drawer (simple) ===== */
    .cart-drawer{
      position:fixed; right:18px; top:88px; width:340px; max-width:92vw;
      background:#fff; border:1px solid var(--line); border-radius:12px; box-shadow:var(--shadow);
      z-index:80; padding:12px; display:none; flex-direction:column; gap:8px;
    }
    .cart-drawer.open{display:flex}
    .cart-item{display:flex; gap:10px; align-items:center; justify-content:space-between}
    .cart-item .meta{flex:1}
    .cart-item .meta h4{margin:0;font-size:14px}
    .cart-item .meta p{margin:4px 0 0;font-size:13px;color:var(--muted)}
    .cart-total{font-weight:900;text-align:right;margin-top:8px}

    /* ===== Responsive ===== */
    @media (max-width: 1100px){
      .grid{grid-template-columns: repeat(3, minmax(0,1fr))}
    }
    @media (max-width: 980px){
      .product-page{grid-template-columns:1fr}
      .media img{height:320px}
    }
    @media (max-width: 900px){
      .search{display:none}
      nav.desktop-nav{display:none}
      .hamburger{display:inline-flex}
      .brand{min-width: unset}
      .grid{grid-template-columns: repeat(2, minmax(0,1fr))}
      .cart-drawer{right:10px; left:10px; top:auto; bottom:16px}
    }
    @media (max-width: 430px){
      .card img{height:150px}
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="wrap">
      <div>support@glacierbiolabs.com</div>
      <div class="right">
        <a href="#/shop">Shop</a>
        <a href="#/account">My Account</a>
      </div>
    </div>
  </div>

  <header>
    <div class="wrap header">
      <button class="hamburger" id="open-drawer" aria-label="Open menu" type="button">‚ò∞</button>

      <a class="brand" href="#/">
        <img id="site-logo" class="logo" src="images/logo.png" alt="Glacier BioLabs" onerror="this.style.display='none'">
        <div class="brand-text">
          <strong>Glacier BioLabs</strong>
          <span>Research Use Only</span>
        </div>
      </a>

      <nav class="desktop-nav" aria-label="Main navigation" id="desktop-nav">
        <a href="#/shop" data-nav="shop">BUY PEPTIDES</a>
        <a href="#/learn" data-nav="learn">ABOUT</a>
        <a href="#/knowledge" data-nav="knowledge">KNOWLEDGE</a>
        <a href="#/faq" data-nav="contact">CONTACT</a>
      </nav>

      <div style="display:flex;align-items:center;gap:10px">
        <form class="search" id="search-form" onsubmit="return false">
          <label class="sr-only" for="q">Search</label>
          <input id="q" type="search" placeholder="Search products..." autocomplete="off">
          <button type="submit" aria-label="Search">üîé</button>
        </form>

        <div class="header-actions">
          <a class="pill" href="#/shop" title="Browse products">Shop</a>
          <button class="pill" id="cart-toggle" type="button">Cart <span id="cart-count" style="background:var(--accent);color:#fff;padding:4px 8px;border-radius:999px;font-weight:900;margin-left:6px">0</span></button>
        </div>
      </div>
    </div>
  </header>

  <!-- Mobile drawer -->
  <div class="drawer-backdrop" id="drawer-backdrop"></div>
  <aside class="drawer" id="drawer" aria-hidden="true">
    <div class="head">
      <strong>Menu</strong>
      <button class="close" id="close-drawer" aria-label="Close menu" type="button">‚úï</button>
    </div>
    <div class="body">
      <a href="#/shop">BUY PEPTIDES</a>
      <a href="#/learn">ABOUT</a>
      <a href="#/knowledge">KNOWLEDGE</a>
      <a href="#/faq">CONTACT</a>
      <a href="#/account">MY ACCOUNT</a>
    </div>
  </aside>

  <!-- Cart drawer -->
  <div id="cart-drawer" class="cart-drawer" aria-hidden="true">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <strong>Your Cart</strong>
      <button id="close-cart" style="border:1px solid var(--line);background:#fff;border-radius:10px;padding:6px 8px;cursor:pointer" type="button">Close</button>
    </div>

    <div id="cart-contents"></div>

    <div id="cart-footer" style="margin-top:8px">
      <div class="cart-total" id="cart-total"></div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="checkout-from-cart" class="add-to-cart-btn" style="flex:1" type="button">Checkout</button>
        <button id="clear-cart" class="buy-now-btn" style="border:1px solid var(--line);background:#fff" type="button">Clear</button>
      </div>
      <div style="font-size:12px;color:var(--muted);margin-top:8px">Cart checkout will create a single Stripe Checkout session with all items (server must support cart payload).</div>
    </div>
  </div>

  <main id="app" class="wrap"></main>

  <section class="newsletter">
    <div class="wrap">
      <div>
        <h3>SUBSCRIBE TO OUR NEWSLETTER</h3>
        <p>Get promotions and updates sent to your inbox.</p>
      </div>
      <form class="nl-form" id="nl-form">
        <input placeholder="First Name" name="first" />
        <input placeholder="Last Name" name="last" />
        <input class="wide" placeholder="Email" name="email" type="email" required />
        <input class="wide" placeholder="Phone (optional)" name="phone" />
        <button type="submit">SUBSCRIBE</button>
      </form>
    </div>
  </section>

  <footer>
    <div class="wrap">
      ¬© <span id="year"></span> Glacier BioLabs ‚Äî Research Use Only ‚Äî Not for human or veterinary use.
    </div>
  </footer>

  <script>
  // ===== Client-side logic (full site restored + new product view) =====

  // Stripe: client loads publishable key from server at /config (server holds secret)
  let stripe = null;
  let stripeReady = false;
  (async function loadKey(){
    try {
      const r = await fetch('/config');
      if (!r.ok) return;
      const { publishableKey } = await r.json();
      if (publishableKey) {
        stripe = Stripe(publishableKey);
        stripeReady = true;
      }
    } catch(e){ console.warn('Could not load publishable key', e); }
  })();

  // Images & Products (your provided list/prices)
  const IMAGE_DIR = 'images/';
  const IMAGE_FILES = {
    logo: 'logo.png',
    retatrutide: 'retatrutide-10mg.png',
    ghk: 'ghk-cu-50mg.png',
    mt2: 'mt2-10mg.png',
    bpc: 'bpc-157-10mg.png',
    water: 'bacteriostatic-water-10ml.png',
    coa: 'coa-sample.png'
  };

  const PRODUCTS = [
    { slug: 'retatrutide', name: 'Retatrutide (10 mg)', price: 8500, oldPrice: 11249, category: 'Peptides', inStock:true, image: IMAGE_FILES.retatrutide, short: 'High-purity compound supplied for controlled laboratory research.', long: `Retatrutide is supplied as a lyophilized research compound intended exclusively for laboratory, analytical, and scientific investigation. In published literature it has been examined in controlled models related to metabolic signaling pathways. This listing is for research use only (RUO).`},
    { slug: 'ghk-cu', name: 'GHK-Cu (Copper Peptide) ‚Äì 50 mg', price: 4500, category: 'Peptides', inStock:true, image: IMAGE_FILES.ghk, short: 'Copper-binding peptide used in research models.', long: `GHK-Cu is supplied as a research compound intended for laboratory use only.`},
    { slug: 'melanotan-ii', name: 'Melanotan II (10 mg)', price: 4000, category: 'Peptides', inStock:true, image: IMAGE_FILES.mt2, short:'Research analog used to study melanocortin receptor pathways.', long:'Melanotan II is supplied as a lyophilized research compound. Research use only.'},
    { slug: 'bpc-157', name: 'BPC-157 (10 mg)', price: 5500, category: 'Peptides', inStock:true, image: IMAGE_FILES.bpc, short:'Peptide fragment used in controlled research models.', long:'BPC-157 is provided strictly as a research compound.'},
    { slug: 'water', name:'Bacteriostatic Water (10 mL)', price:1000, category:'Supplies', inStock:true, image: IMAGE_FILES.water, short:'Sterile diluent typically used for laboratory reconstitution workflows.', long:'Bacteriostatic water is a sterile solution supplied for laboratory handling.'}
  ];

  const PLACEHOLDER = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="900" height="650"><rect width="100%" height="100%" fill="#ffffff"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#94a3b8" font-family="Arial" font-size="18">Image not available</text></svg>');

  // Cart (localStorage)
  const CART_KEY = 'glacier_cart_v1';
  function readCart(){ try { return JSON.parse(localStorage.getItem(CART_KEY) || '[]'); } catch(e){ return []; } }
  function writeCart(cart){ localStorage.setItem(CART_KEY, JSON.stringify(cart)); updateCartUI(); }
  function addToCart(slug, qty=1){ const cart = readCart(); const i = cart.findIndex(x=>x.slug===slug); if(i===-1) cart.push({slug,qty}); else cart[i].qty += qty; writeCart(cart); }
  function removeFromCart(slug){ writeCart(readCart().filter(i=>i.slug!==slug)); }
  function setQty(slug, qty){ const cart = readCart(); const i = cart.findIndex(x=>x.slug===slug); if(i!==-1){ cart[i].qty = Math.max(1, qty); writeCart(cart); } }
  function clearCart(){ writeCart([]); }
  function cartCount(){ return readCart().reduce((s,i)=>s + (i.qty||0), 0); }
  function cartTotal(){ return readCart().reduce((sum,item)=>{ const p = PRODUCTS.find(x=>x.slug===item.slug); return sum + (p ? p.price * (item.qty||0) : 0); }, 0); }
  function updateCartUI(){ const el = document.getElementById('cart-count'); if(el) el.textContent = String(cartCount()); const contents = document.getElementById('cart-contents'); const total = document.getElementById('cart-total'); if(!contents || !total) return; const cart = readCart(); if(cart.length===0){ contents.innerHTML = '<div style="color:var(--muted);text-align:center;padding:12px">Your cart is empty.</div>'; total.textContent = ''; return; } contents.innerHTML = cart.map(item=>{ const p = PRODUCTS.find(x=>x.slug===item.slug) || {name:item.slug,price:0}; return `<div class="cart-item" data-slug="${item.slug}"><div class="meta"><h4>${p.name}</h4><p>${money(p.price)} √ó <input class="qty-input" type="number" min="1" value="${item.qty}" style="width:60px;padding:6px;border-radius:8px;border:1px solid var(--line)"></p></div><div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px"><div style="font-weight:900">${money(p.price * item.qty)}</div><button class="buy-now-btn" data-remove="${item.slug}" style="border:1px solid var(--line);background:#fff;padding:6px;border-radius:8px;cursor:pointer">Remove</button></div></div>` }).join(''); total.textContent = 'Total: ' + money(cartTotal()); // wire inputs and remove
    contents.querySelectorAll('.cart-item').forEach(el => {
      const slug = el.getAttribute('data-slug');
      const input = el.querySelector('.qty-input');
      const removeBtn = el.querySelector('[data-remove]');
      if(input) input.addEventListener('change', ()=> { const v = Number(input.value||1); if(isNaN(v)||v<1) input.value='1'; setQty(slug, Math.floor(v)); });
      if(removeBtn) removeBtn.addEventListener('click', ()=> removeFromCart(slug));
    });
  }

  function money(cents){ return '$' + (cents/100).toFixed(2); }
  function imgPath(f){ return IMAGE_DIR + f; }

  // ===== Views & Router =====
  function setActiveNav(){
    const hash = location.hash || '#/';
    document.querySelectorAll('[data-nav]').forEach(a=>a.classList.remove('active'));
    if(hash.startsWith('#/shop')||hash==='#/'||hash==='#') { const s=document.querySelector('[data-nav="shop"]'); if(s) s.classList.add('active'); }
    if(hash.startsWith('#/learn')) { const s=document.querySelector('[data-nav="learn"]'); if(s) s.classList.add('active'); }
    if(hash.startsWith('#/knowledge')) { const s=document.querySelector('[data-nav="knowledge"]'); if(s) s.classList.add('active'); }
    if(hash.startsWith('#/faq')) { const s=document.querySelector('[data-nav="contact"]'); if(s) s.classList.add('active'); }
    if(hash.startsWith('#/product/')) { const s=document.querySelector('[data-nav="shop"]'); if(s) s.classList.add('active'); }
  }

  function route(){
    const app = document.getElementById('app');
    if(!app) return;
    setActiveNav();
    const hash = location.hash || '#/';
    if(hash.startsWith('#/product/')){ const slug = decodeURIComponent(hash.split('#/product/')[1]||''); renderProduct(app, slug); return; }
    switch(hash){
      case '#/':
      case '#': renderHome(app); break;
      case '#/shop': renderShop(app); break;
      case '#/learn': renderLearn(app); break;
      case '#/knowledge': renderKnowledge(app); break;
      case '#/faq': renderFAQ(app); break;
      case '#/account': renderAccount(app); break;
      default: location.hash = '#/'; break;
    }
    updateCartUI();
  }

  // Home
  function renderHome(app){
    app.innerHTML = `
      <section class="hero">
        <div class="wrap">
          <div>
            <div class="kicker">FREE SAME DAY PRIORITY SHIPPING</div>
            <h1>RESEARCH COMPOUNDS</h1>
            <p>Research Use Only ‚Äî Not for human or veterinary use. Built for clean catalog browsing and fast mobile checkout.</p>

            <div class="cta-row">
              <a class="btn primary" href="#/shop">BUY PEPTIDES ONLINE</a>
              <a class="btn ghost" href="#/knowledge">KNOWLEDGE CENTER</a>
            </div>

            <div class="badge">Free US shipping ‚Ä¢ Priority (1‚Äì3 business days) on orders over $199</div>
          </div>

          <div class="panel">
            <strong>Research-first storefront</strong>
            <small>
              Mobile-optimized catalog layout, clean product detail pages, and a consistent red brand system.
            </small>
          </div>
        </div>
      </section>

      <section class="section">
        <div class="wrap">
          <h2>OUR BEST SELLERS</h2>
          <p class="subhead">Clean product cards, consistent spacing, and a layout that looks legit on iPhone.</p>
          <div class="grid">
            ${PRODUCTS.slice(0,4).map(p=>productCardHTML(p)).join('')}
          </div>
        </div>
      </section>

      <section class="section">
        <div class="wrap">
          <h2>Shop All Products</h2>
          <p class="subhead">Browse the full catalog with filters and sorting.</p>
          <a class="btn primary" href="#/shop">Open Catalog</a>
        </div>
      </section>
    `;
  }

  function productCardHTML(p){
    return `
      <article class="card">
        <a href="#/product/${encodeURIComponent(p.slug)}" aria-label="${p.name}">
          <div class="img-wrap">
            <div class="img-topbar"></div>
            <img src="${imgPath(p.image)}" alt="${p.name}" onerror="this.onerror=null;this.src='${PLACEHOLDER}'">
          </div>
        </a>
        <div class="body">
          <h3>${p.name}</h3>
          <div class="stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
          <div class="price">${money(p.price)}</div>
          <div class="small">${p.short}</div>
          <div class="actions">
            <button class="buy-now-btn" onclick="addToCart('${p.slug}',1);updateCartUI();">ADD TO CART</button>
            <button class="add-to-cart-btn" onclick="buyNow('${p.slug}',1)">BUY NOW</button>
          </div>
        </div>
      </article>
    `;
  }

  function renderShop(app){
    const categories = Array.from(new Set(PRODUCTS.map(p=>p.category))).sort();
    app.innerHTML = `
      <section class="section">
        <div class="wrap">
          <div class="catalog">
            <aside class="filters" aria-label="Filters">
              <div class="filter-block">
                <h3>Price</h3>
                <div class="filter-line"></div>
                <div class="price-range">
                  <input id="minPrice" inputmode="numeric" placeholder="Min">
                  <input id="maxPrice" inputmode="numeric" placeholder="Max">
                  <button id="applyPrice" type="button">Apply</button>
                </div>
              </div>

              <div class="filter-block">
                <h3>Stock</h3>
                <div class="filter-line"></div>
                <label class="check">
                  <input id="inStock" type="checkbox"> In Stock
                </label>
              </div>

              <div class="filter-block">
                <h3>Category</h3>
                <div class="filter-line"></div>
                ${categories.map(cat=>`<label class="check"><input class="cat" type="checkbox" value="${cat}">${cat}<span class="chip">${PRODUCTS.filter(p=>p.category===cat).length}</span></label>`).join('')}
              </div>
            </aside>

            <div>
              <div class="catalog-head">
                <div class="count">Showing ${PRODUCTS.length} results</div>
                <div class="sort">
                  <label class="sr-only" for="sort">Sort</label>
                  <select id="sort">
                    <option value="default">Default</option>
                    <option value="price-asc">Price low‚Üíhigh</option>
                    <option value="price-desc">Price high‚Üílow</option>
                    <option value="name-asc">Name A‚ÜíZ</option>
                  </select>
                </div>
              </div>

              <div class="grid" id="shop-grid">
                ${PRODUCTS.map(p=>productCardHTML(p)).join('')}
              </div>
            </div>
          </div>
        </div>
      </section>
    `;

    // basic wiring (re-render on filter change)
    document.getElementById('applyPrice')?.addEventListener('click', ()=>{ /* kept simple for demo */ });
  }

  // ===== Product detail (new design matching screenshot 2) =====
  function renderProduct(app, slug){
    const p = PRODUCTS.find(x=>x.slug===slug);
    if(!p){
      app.innerHTML = `<section class="section"><div class="wrap"><div class="page"><h1>Product not found</h1><p class="muted">That product doesn‚Äôt exist.</p><a class="btn primary" href="#/shop">Back to shop</a></div></div></section>`;
      return;
    }

    app.innerHTML = `
      <div class="crumbs"><a class="backlink" href="#/shop">‚Üê Back to Shop</a></div>
      <div class="product-page">
        <div class="media">
          <div class="img-topbar"></div>
          <div style="display:flex;justify-content:center;"><img id="main-img" src="${imgPath(p.image)}" alt="${p.name}" onerror="this.onerror=null;this.src='${PLACEHOLDER}'"></div>
          <div class="thumb-row">
            <div class="thumb" data-src="${imgPath(p.image)}"><img src="${imgPath(p.image)}" onerror="this.onerror=null;this.src='${PLACEHOLDER}'"></div>
            <div class="thumb" data-src="${imgPath(IMAGE_FILES.coa)}"><img src="${imgPath(IMAGE_FILES.coa)}" onerror="this.onerror=null;this.src='${PLACEHOLDER}'"></div>
          </div>
        </div>

        <div class="pinfo">
          <h1>${p.name}</h1>
          <div class="rating-row"><span style="color:var(--accent-2);font-weight:900">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span><span class="muted">Trusted by researchers</span><span class="muted">‚Ä¢</span><span class="muted">${p.inStock ? 'In Stock' : 'Out of Stock'}</span></div>

          <div class="price-row">${p.oldPrice ? `<div class="old">${money(p.oldPrice)}</div>` : ''}<div class="now">${money(p.price)}</div></div>

          <div style="margin-top:12px">
            <button id="add-to-cart" class="add-to-cart-btn">Add to Cart</button>
            <div style="height:10px"></div>
            <button id="buy-now" class="buy-now-btn">Buy Now</button>
          </div>

          <div class="ruo">RESEARCH USE ONLY ‚Äî Not for human or veterinary use. No medical claims are made.</div>

          <div class="desc" style="margin-top:12px;color:var(--muted);line-height:1.6">${p.short}</div>

          <div class="product-sections">
            <h3>Product Summary</h3>
            <p>${p.long}</p>

            <h3>Overview</h3>
            <p>Retatrutide is categorized as a multi-agonist synthetic peptide. Multi-agonist compounds are researched for their ability to interact with multiple receptor systems, supporting investigations into complex metabolic and endocrine signaling pathways in controlled experimental models.</p>

            <h3>Proposed Mechanism of Action (Research Context)</h3>
            <p>Scientific literature suggests Retatrutide may interact with incretin-related receptors such as GLP-1 and GIP, as well as glucagon receptors. These interactions are hypothesized to influence receptor-mediated cellular signaling pathways (including cAMP-linked signaling). All mechanisms remain under investigation and are presented strictly within a research context.</p>

            <h3>Research Context & Scientific Interest</h3>
            <p>Multi-agonist peptides such as Retatrutide are explored in lab environments to study receptor cross-talk, signaling efficiency, and comparative pathway activation in metabolic research frameworks.</p>

            <h3>Chemical Profile</h3>
            <p>This product is supplied as a lyophilized powder in a sealed sterile vial. COA documentation is available via the gallery when provided for the batch.</p>

            <h3>What You Receive</h3>
            <p>Each order includes a sealed sterile vial containing the product in lyophilized form. COA is available in the gallery when included for the batch.</p>
          </div>
        </div>
      </div>
    `;

    // thumbnails -> main image
    document.querySelectorAll('.thumb').forEach(t => t.addEventListener('click', ()=>{ const src = t.getAttribute('data-src'); const m = document.getElementById('main-img'); if(m) m.src = src; }));

    // Add to cart handler
    document.getElementById('add-to-cart')?.addEventListener('click', ()=>{
      addToCart(p.slug,1);
      updateCartUI();
      const btn = document.getElementById('add-to-cart');
      if(btn){ btn.textContent = 'Added'; setTimeout(()=>btn.textContent='Add to Cart',1000); }
    });

    // Buy now handler (single-item checkout)
    document.getElementById('buy-now')?.addEventListener('click', async ()=>{
      if(!stripeReady){ alert('Payment not ready.'); return; }
      const email = prompt('Enter your email for receipt:');
      if(!email){ alert('Email required'); return; }
      try {
        const resp = await fetch('/create-checkout-session', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ slug: p.slug, qty:1, email, successUrl: window.location.origin + '/?checkout=success', cancelUrl: window.location.href })
        });
        const data = await resp.json();
        if(!resp.ok){ console.error(data); alert(data?.message || 'Failed to create checkout session'); return; }
        if(!data.sessionId){ alert('No sessionId returned from server'); return; }
        const { error } = await stripe.redirectToCheckout({ sessionId: data.sessionId });
        if(error){ alert(error.message || 'Stripe error'); }
      } catch(err){ console.error(err); alert('Unexpected error'); }
    });
  }

  function renderLearn(app){ app.innerHTML = `<section class="section"><div class="wrap"><div class="page"><h1>About Glacier BioLabs</h1><p>Glacier BioLabs is a research-first storefront for laboratory and scientific research materials. All products are offered strictly for research use only (RUO) and are not intended for human or veterinary use.</p></div></div></section>`; }
  function renderKnowledge(app){ app.innerHTML = `<section class="section"><div class="wrap"><div class="page"><h1>Knowledge Center</h1><p>This page provides general, non-clinical information about research compounds, testing, and lab handling. Content is educational only and not medical advice.</p></div></div></section>`; }
  function renderFAQ(app){ app.innerHTML = `<section class="section"><div class="wrap"><div class="page"><h1>Contact</h1><p>For support, reach us at <strong>support@glacierbiolabs.com</strong>.</p></div></div></section>`; }
  function renderAccount(app){ app.innerHTML = `<section class="section"><div class="wrap"><div class="page"><h1>My Account</h1><p class="muted">Account/login is a placeholder right now.</p></div></div></section>`; }

  // quick buyNow for product cards (exposed)
  async function buyNow(slug, qty=1){
    const p = PRODUCTS.find(x=>x.slug===slug);
    if(!p){ alert('Product not found'); return; }
    if(!stripeReady){ alert('Payment not ready'); return; }
    const email = prompt('Enter your email for receipt:');
    if(!email){ alert('Email required'); return; }
    try {
      const resp = await fetch('/create-checkout-session', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ slug, qty, email, successUrl: window.location.origin + '/?checkout=success', cancelUrl: window.location.href })
      });
      const data = await resp.json();
      if(!resp.ok){ console.error(data); alert(data?.message || 'Failed to create session'); return; }
      if(!data.sessionId){ alert('No sessionId'); return; }
      const { error } = await stripe.redirectToCheckout({ sessionId: data.sessionId });
      if(error){ alert(error.message || 'Stripe error'); }
    } catch(e){ console.error(e); alert('Unexpected error'); }
  }

  // ===== UX wiring =====
  function setupDrawer(){
    const drawer = document.getElementById('drawer');
    const backdrop = document.getElementById('drawer-backdrop');
    const openBtn = document.getElementById('open-drawer');
    const closeBtn = document.getElementById('close-drawer');
    function open(){ if(!drawer||!backdrop||!openBtn) return; drawer.classList.add('open'); backdrop.style.display='block'; drawer.setAttribute('aria-hidden','false'); openBtn.setAttribute('aria-expanded','true'); if(closeBtn) closeBtn.focus(); }
    function close(){ if(!drawer||!backdrop||!openBtn) return; drawer.classList.remove('open'); backdrop.style.display='none'; drawer.setAttribute('aria-hidden','true'); openBtn.setAttribute('aria-expanded','false'); openBtn.focus(); }
    if(openBtn) openBtn.addEventListener('click', open);
    if(closeBtn) closeBtn.addEventListener('click', close);
    if(backdrop) backdrop.addEventListener('click', close);
    if(drawer) drawer.querySelectorAll('a').forEach(a=>a.addEventListener('click', close));
    document.addEventListener('keydown', e=>{ if(e.key==='Escape'){ close(); closeCart(); } });
  }

  function setupSearch(){
    const form = document.getElementById('search-form');
    const q = document.getElementById('q');
    if(!form||!q) return;
    form.addEventListener('submit', (e)=>{ e.preventDefault(); location.hash = '#/shop'; route(); });
  }

  function setupBrandAssets(){ document.getElementById('site-logo')?.setAttribute('src', imgPath(IMAGE_FILES.logo)); document.getElementById('year') && (document.getElementById('year').textContent = String(new Date().getFullYear())); }

  function openCart(){ const d=document.getElementById('cart-drawer'); if(d){ d.classList.add('open'); d.setAttribute('aria-hidden','false'); updateCartUI(); } }
  function closeCart(){ const d=document.getElementById('cart-drawer'); if(d){ d.classList.remove('open'); d.setAttribute('aria-hidden','true'); } }

  // Boot
  window.addEventListener('hashchange', route);
  document.addEventListener('DOMContentLoaded', ()=>{
    setupDrawer();
    setupSearch();
    setupBrandAssets();
    updateCartUI();

    document.getElementById('cart-toggle')?.addEventListener('click', ()=> openCart());
    document.getElementById('close-cart')?.addEventListener('click', ()=> closeCart());
    document.getElementById('clear-cart')?.addEventListener('click', ()=> { if(confirm('Clear cart?')) clearCart(); });

    document.getElementById('checkout-from-cart')?.addEventListener('click', async ()=>{
      const cart = readCart();
      if(cart.length===0){ alert('Cart is empty'); return; }
      if(!stripeReady){ alert('Payment not ready'); return; }
      const email = prompt('Enter your email for receipt:');
      if(!email){ alert('Email required'); return; }
      try {
        const resp = await fetch('/create-checkout-session', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ cart, email, successUrl: window.location.origin + '/?checkout=success', cancelUrl: window.location.href })});
        const data = await resp.json();
        if(!resp.ok){ console.error(data); alert(data?.message||'Failed'); return; }
        if(!data.sessionId){ alert('No sessionId'); return; }
        const { error } = await stripe.redirectToCheckout({ sessionId: data.sessionId });
        if(error) alert(error.message || 'Stripe error');
      } catch(e){ console.error(e); alert('Unexpected'); }
    });

    if(!location.hash) location.hash = '#/';
    route();
  });
  </script>
</body>
</html>