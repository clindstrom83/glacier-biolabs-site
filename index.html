<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Glacier BioLabs ‚Äî Research Peptides</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="Glacier BioLabs ‚Äî Research Use Only compounds." />
  <style>
    :root{
      --accent:#d0352c;           /* primary red */
      --accent-2:#b12a24;         /* darker red */
      --accent-soft: rgba(208,53,44,.10);
      --ink:#0f172a;
      --muted:#64748b;
      --line:#e5e7eb;
      --bg:#ffffff;
      --card:#ffffff;
      --shadow: 0 10px 25px rgba(2,6,23,.08);
      --radius: 14px;
      --radius-sm: 10px;
      --max: 1180px;

      --topbar-h: 36px;
      --header-h: 72px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:var(--bg);
      color:var(--ink);
    }
    a{color:inherit;text-decoration:none}
    button,input,select,textarea{font:inherit}

    .wrap{max-width:var(--max); margin:0 auto; padding:0 16px}
    .muted{color:var(--muted)}
    .sr-only{position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden}

    /* ===== Topbar + Header ===== */
    .topbar{
      height:var(--topbar-h);
      background:var(--accent-2);
      color:#fff;
      display:flex;
      align-items:center;
      font-size:13px;
    }
    .topbar .wrap{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .topbar .right{
      display:flex; gap:14px; align-items:center;
      opacity:.95;
    }
    .topbar a{color:#fff; opacity:.95}
    .topbar a:hover{opacity:1; text-decoration:underline}

    header{
      position:sticky;
      top:0;
      z-index:50;
      background:#fff;
      border-bottom:1px solid var(--line);
    }
    .header{
      height:var(--header-h);
      display:flex;
      align-items:center;
      gap:14px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 220px;
    }
    .logo{
      height:40px;width:auto; display:block;
    }
    .brand-text{
      display:flex; flex-direction:column; line-height:1.05;
    }
    .brand-text strong{font-size:15px; letter-spacing:.2px}
    .brand-text span{font-size:12px; color:var(--muted)}

    nav.desktop-nav{
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:18px;
      font-weight:600;
      font-size:14px;
    }
    nav.desktop-nav a{
      padding:10px 8px;
      border-radius:10px;
    }
    nav.desktop-nav a:hover{background:rgba(2,6,23,.04)}
    nav.desktop-nav a.active{
      color:var(--accent-2);
      background:var(--accent-soft);
    }

    .search{
      display:flex; align-items:center; gap:0;
      width: 360px;
      max-width: 38vw;
    }
    .search input{
      width:100%;
      border:1px solid var(--line);
      border-right:none;
      padding:11px 12px;
      border-radius:999px 0 0 999px;
      outline:none;
    }
    .search input:focus{
      border-color: rgba(208,53,44,.45);
      box-shadow: 0 0 0 4px rgba(208,53,44,.12);
    }
    .search button{
      border:1px solid var(--line);
      background:var(--accent);
      color:#fff;
      padding:11px 14px;
      border-radius:0 999px 999px 0;
      cursor:pointer;
      font-weight:700;
    }
    .search button:hover{background:var(--accent-2)}

    .header-actions{
      display:flex; align-items:center; gap:10px;
    }

    .cart-pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:999px;
      font-weight:700;
      font-size:13px;
      background:#fff;
      cursor:pointer;
    }
    .cart-pill:hover{box-shadow:0 6px 16px rgba(2,6,23,.08)}

    /* ===== Mobile controls ===== */
    .hamburger{
      display:none;
      border:1px solid var(--line);
      background:#fff;
      border-radius:12px;
      padding:10px 12px;
      cursor:pointer;
    }

    .drawer-backdrop{
      position:fixed; inset:0;
      background:rgba(2,6,23,.55);
      display:none;
      z-index:60;
    }
    .drawer{
      position:fixed; top:0; right:0;
      height:100%;
      width:min(420px, 92vw);
      background:#fff;
      z-index:70;
      transform:translateX(100%);
      transition:transform .25s ease;
      display:flex;
      flex-direction:column;
    }
    .drawer.open{transform:translateX(0)}
    .drawer .head{
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between;
    }
    .drawer .body{padding:16px; display:flex; flex-direction:column; gap:8px}
    .drawer .body a{
      padding:12px 12px;
      border:1px solid var(--line);
      border-radius:12px;
      font-weight:700;
    }
    .drawer .body a:hover{background:rgba(2,6,23,.03)}
    .drawer .close{
      border:1px solid var(--line);
      background:#fff;
      border-radius:12px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:800;
    }

    /* ===== Hero ===== */
    .hero{
      position:relative;
      overflow:hidden;
      border-bottom:1px solid var(--line);
      background:
        radial-gradient(1200px 500px at 20% 30%, rgba(208,53,44,.35), transparent 55%),
        radial-gradient(1000px 500px at 75% 30%, rgba(2,6,23,.18), transparent 60%),
        linear-gradient(135deg, rgba(2,6,23,.75), rgba(2,6,23,.45));
    }
    .hero::before{
      content:"";
      position:absolute; inset:0;
      background:
        url("images/hero.jpg") center/cover no-repeat;
      opacity:.22;
      filter:saturate(1.1) contrast(1.05);
    }
    .hero .wrap{
      position:relative;
      padding:56px 16px 48px;
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      align-items:center;
      gap:26px;
    }
    .hero h1{
      margin:0;
      color:#fff;
      font-size:42px;
      letter-spacing:.4px;
    }
    .hero p{
      margin:10px 0 0;
      color:rgba(255,255,255,.88);
      font-size:16px;
      max-width: 56ch;
      line-height:1.45;
    }
    .hero .kicker{
      display:inline-flex;
      gap:10px; align-items:center;
      color:rgba(255,255,255,.85);
      font-weight:800;
      letter-spacing:.18em;
      text-transform:uppercase;
      font-size:12px;
      margin-bottom:10px;
    }
    .hero .cta-row{
      margin-top:18px;
      display:flex; gap:12px; flex-wrap:wrap;
      align-items:center;
    }
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      gap:10px;
      padding:12px 16px;
      border-radius:999px;
      border:1px solid transparent;
      font-weight:800;
      cursor:pointer;
      white-space:nowrap;
    }
    .btn.primary{
      background:var(--accent);
      color:#fff;
      box-shadow:0 14px 30px rgba(208,53,44,.28);
    }
    .btn.primary:hover{background:var(--accent-2)}
    .btn.ghost{
      background:transparent;
      border-color:rgba(255,255,255,.25);
      color:#fff;
    }
    .btn.ghost:hover{background:rgba(255,255,255,.08)}
    .hero .badge{
      display:inline-flex;
      align-items:center;
      padding:10px 12px;
      border-radius:999px;
      background:rgba(255,255,255,.12);
      color:#fff;
      border:1px solid rgba(255,255,255,.18);
      font-weight:700;
      margin-top:14px;
    }
    .hero .panel{
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.14);
      border-radius: var(--radius);
      padding:16px;
      backdrop-filter: blur(6px);
      color:#fff;
    }
    .hero .panel strong{display:block; font-size:14px; letter-spacing:.2px}
    .hero .panel small{display:block; opacity:.88; margin-top:6px; line-height:1.35}

    /* ===== Page sections ===== */
    main{padding:24px 0 0}
    .section{padding:26px 0}
    .section h2{
      margin:0 0 14px;
      font-size:26px;
      letter-spacing:.3px;
    }
    .subhead{
      margin:-8px 0 18px;
      color:var(--muted);
      line-height:1.45;
      max-width: 70ch;
    }
    .divider{height:1px; background:var(--line); margin:20px 0}

    /* ===== Catalog layout ===== */
    .catalog{
      display:grid;
      grid-template-columns: 280px 1fr;
      gap:26px;
      align-items:start;
    }
    aside.filters{
      border-right:1px solid var(--line);
      padding-right:18px;
    }
    .filter-block{padding:6px 0 16px}
    .filter-block h3{
      margin:0 0 10px;
      font-size:16px;
      letter-spacing:.2px;
    }
    .filter-line{height:1px; background:var(--line); margin:10px 0 14px}
    .check{
      display:flex; align-items:center; gap:10px;
      padding:10px 0;
      cursor:pointer;
      user-select:none;
      font-weight:600;
      color:var(--ink);
    }
    .check input{width:18px;height:18px}
    .chip{
      display:inline-flex; align-items:center;
      font-size:12px;
      font-weight:800;
      border-radius:999px;
      padding:4px 8px;
      background:rgba(2,6,23,.05);
      margin-left:auto;
      color:var(--muted);
    }
    .price-range{
      display:flex; gap:10px; align-items:center;
      flex-wrap:wrap;
    }
    .price-range input{
      width:120px;
      padding:10px 10px;
      border:1px solid var(--line);
      border-radius:12px;
    }
    .price-range button{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      font-weight:800;
      cursor:pointer;
    }
    .price-range button:hover{box-shadow:0 10px 22px rgba(2,6,23,.08)}

    .catalog-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:12px;
    }
    .catalog-head .count{
      font-weight:700;
      color:var(--muted);
    }
    .sort{
      display:flex; align-items:center; gap:10px;
    }
    .sort select{
      padding:10px 10px;
      border:1px solid var(--line);
      border-radius:12px;
      background:#fff;
      font-weight:700;
    }

    /* ===== Product cards ===== */
    .grid{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap:18px;
    }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      overflow:hidden;
      transition:transform .14s ease, box-shadow .14s ease;
    }
    .card:hover{
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }
    .card .img-wrap{
      position:relative;
      background:#fff;
      border-bottom:1px solid var(--line);
      padding:12px;
    }
    .card .img-topbar{
      position:absolute; left:0; top:0; right:0;
      height:6px;
      background:var(--accent);
      opacity:.95;
    }
    .card img{
      width:100%;
      height:170px;
      object-fit:contain;
      background:#fff;
      border-radius:12px;
      display:block;
    }
    .tag-sale{
      position:absolute;
      left:12px; top:14px;
      background:var(--accent);
      color:#fff;
      font-weight:900;
      font-size:12px;
      padding:8px 10px;
      border-radius:12px;
      box-shadow:0 12px 24px rgba(208,53,44,.25);
    }
    .card .body{
      padding:14px 14px 16px;
    }
    .card h3{
      margin:0;
      font-size:15px;
      line-height:1.25;
      letter-spacing:.2px;
      min-height: 38px;
    }
    .stars{
      display:flex; align-items:center; justify-content:center;
      gap:2px;
      margin:10px 0 6px;
      color: var(--accent-2);
      font-weight:900;
      font-size:12px;
      letter-spacing:.05em;
    }
    .price{
      text-align:center;
      font-weight:900;
      color: var(--accent-2);
      margin:6px 0 10px;
      font-size:15px;
    }
    .card .small{
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
      min-height: 36px;
    }
    .card .actions{
      margin-top:12px;
      display:flex; justify-content:space-between; gap:8px;
    }

    /* small variant: tighter padding, less rounded (prevents pill button from appearing clipped) */
    .btn.small{
      padding:8px 12px;
      font-size:13px;
      border-radius:12px; /* override 999px for compact buttons */
    }
    .card .actions .btn{
      flex:1;
      min-width:0;
    }
    .card .actions .btn + .btn{ margin-left:8px; }

    /* ===== Product detail page ===== */
    .crumbs{
      font-size:13px;
      color:var(--muted);
      margin:6px 0 16px;
    }
    .product-page{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:26px;
      align-items:start;
      padding-bottom: 12px;
    }
    .media{
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding:14px;
      background:#fff;
    }
    .media .img-topbar{height:6px;background:var(--accent);border-radius:999px;margin-bottom:12px}
    .media img{
      width:100%;
      height:420px;
      object-fit:contain;
      display:block;
      background:#fff;
      border-radius:12px;
    }
    .pinfo h1{margin:0; font-size:34px; letter-spacing:.3px}
    .pinfo .rating-row{
      display:flex; align-items:center; gap:10px;
      margin:10px 0 10px;
      color:var(--muted);
      font-weight:700;
      font-size:14px;
      flex-wrap:wrap;
    }
    .pinfo .big-price{
      font-size:34px;
      font-weight:950;
      color:var(--accent-2);
      margin:10px 0 12px;
    }
    .pinfo .desc{color:var(--ink); line-height:1.5}
    .ruo{
      margin-top:14px;
      padding:12px 12px;
      border-radius:12px;
      background: var(--accent-soft);
      border:1px solid rgba(208,53,44,.18);
      color: var(--accent-2);
      font-weight:900;
      line-height:1.35;
      font-size:13px;
    }
    .form{
      margin-top:14px;
      display:grid;
      gap:12px;
    }
    .row2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    .field label{
      display:block;
      font-size:13px;
      color:var(--muted);
      font-weight:800;
      margin-bottom:6px;
    }
    .field input, .field select, .field textarea{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      outline:none;
    }
    .field input:focus, .field select:focus, .field textarea:focus{
      border-color: rgba(208,53,44,.45);
      box-shadow: 0 0 0 4px rgba(208,53,44,.12);
    }
    .confirm{
      display:flex; gap:10px; align-items:flex-start;
      padding:12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      font-weight:700;
      color:var(--ink);
      line-height:1.35;
    }
    .confirm input{width:18px;height:18px;margin-top:2px}
    .cta-bar{
      display:flex; gap:12px; align-items:center; flex-wrap:wrap;
      margin-top:8px;
    }
    .backlink{color:var(--muted); font-weight:800}
    .backlink:hover{color:var(--ink)}

    /* ===== Trust icons section ===== */
    .trust{
      border-top:1px solid var(--line);
      border-bottom:1px solid var(--line);
      background:#fff;
    }
    .trust .wrap{padding:28px 16px}
    .trust h2{
      text-align:center;
      margin:0 0 18px;
      letter-spacing:.4px;
    }
    .trust-grid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap:16px;
      align-items:start;
      text-align:center;
    }
    .trust-card{
      padding:14px 12px;
      border-radius: var(--radius);
      border:1px solid var(--line);
      background:#fff;
    }
    .icon{
      width:66px;height:66px;
      border-radius:18px;
      border:2px solid var(--accent);
      display:flex;align-items:center;justify-content:center;
      margin:0 auto 10px;
      background: rgba(208,53,44,.06);
      font-weight:950;
      color:var(--accent-2);
    }
    .trust-card h3{margin:0 0 6px; font-size:15px; letter-spacing:.2px}
    .trust-card p{margin:0; color:var(--muted); line-height:1.45; font-size:13px}

    /* ===== Cart drawer (simple) ===== */
    .cart-drawer{
      position:fixed; right:18px; top:88px; width:340px; max-width:92vw;
      background:#fff; border:1px solid var(--line); border-radius:12px; box-shadow:var(--shadow);
      z-index:80; padding:12px; display:none; flex-direction:column; gap:8px;
    }
    .cart-drawer.open{display:flex}
    .cart-item{display:flex; gap:10px; align-items:center; justify-content:space-between}
    .cart-item .meta{flex:1}
    .cart-item .meta h4{margin:0;font-size:14px}
    .cart-item .meta p{margin:4px 0 0;font-size:13px;color:var(--muted)}
    .cart-total{font-weight:900;text-align:right;margin-top:8px}
    .cart-empty{color:var(--muted);text-align:center;padding:14px 0}

    /* ===== Improved product-page checkout button (new) ===== */
    .product-page { gap: 30px; }
    .pinfo { display:flex; flex-direction:column; gap:12px; }
    .pinfo .big-price { font-size:36px; font-weight:950; color:var(--accent-2); margin:4px 0 8px; }
    .order-row{ display:flex; gap:12px; align-items:center; }
    .order-row .field{ flex:1; margin:0; }
    .btn.primary.full { width:100%; padding:14px 16px; font-size:16px; border-radius:12px; }
    .order-help{ color:var(--muted); font-size:13px; margin-top:8px; }
    @media (max-width:900px){
      .order-row{ flex-direction:column; align-items:stretch; }
    }

    /* ===== Responsive ===== */
    @media (max-width: 1100px){
      .grid{grid-template-columns: repeat(3, minmax(0,1fr))}
    }
    @media (max-width: 900px){
      .search{display:none}
      nav.desktop-nav{display:none}
      .hamburger{display:inline-flex}
      .brand{min-width: unset}
      .hero .wrap{grid-template-columns: 1fr; padding:42px 16px 36px}
      .hero h1{font-size:34px}
      .catalog{grid-template-columns: 1fr}
      aside.filters{display:none}
      .grid{grid-template-columns: repeat(2, minmax(0,1fr))}
      .product-page{grid-template-columns: 1fr}
      .media img{height:320px}
      .trust-grid{grid-template-columns:1fr}
      .nl-form{grid-template-columns:1fr}
      .float-offer{display:none}
      .cart-drawer{right:10px; left:10px; top:auto; bottom:16px}
    }
    @media (max-width: 430px){
      .header{gap:10px}
      .brand-text strong{font-size:14px}
      .hero h1{font-size:30px}
      .grid{gap:14px}
      .card img{height:150px}
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="wrap">
      <div>support@glacierbiolabs.com</div>
      <div class="right">
        <a href="#/shop">Shop</a>
        <a href="#/account">My Account</a>
      </div>
    </div>
  </div>

  <header>
    <div class="wrap header">
      <button type="button" class="hamburger" id="open-drawer" aria-label="Open menu" aria-expanded="false">‚ò∞</button>

      <a class="brand" href="#/">
        <img id="site-logo" class="logo" src="" alt="Glacier BioLabs" onerror="this.style.display='none'">
        <div class="brand-text">
          <strong>Glacier BioLabs</strong>
          <span>Research Use Only</span>
        </div>
      </a>

      <nav class="desktop-nav" aria-label="Main navigation" id="desktop-nav">
        <a href="#/shop" data-nav="shop">BUY PEPTIDES</a>
        <a href="#/learn" data-nav="learn">ABOUT</a>
        <a href="#/knowledge" data-nav="knowledge">KNOWLEDGE</a>
        <a href="#/faq" data-nav="contact">CONTACT</a>
      </nav>

      <form class="search" id="search-form">
        <label class="sr-only" for="q">Search</label>
        <input id="q" type="search" placeholder="Search products..." autocomplete="off">
        <button type="submit" aria-label="Search">üîé</button>
      </form>

      <div class="header-actions">
        <a class="pill" href="#/shop" title="Browse products">Shop</a>
        <button type="button" id="cart-toggle" class="cart-pill" aria-label="Open cart">
          Cart <span id="cart-count" style="background:var(--accent);color:#fff;padding:4px 8px;border-radius:999px;font-weight:900;margin-left:6px">0</span>
        </button>
      </div>
    </div>
  </header>

  <!-- Mobile drawer -->
  <div class="drawer-backdrop" id="drawer-backdrop"></div>
  <aside class="drawer" id="drawer" aria-hidden="true">
    <div class="head">
      <strong>Menu</strong>
      <button type="button" class="close" id="close-drawer" aria-label="Close menu">‚úï</button>
    </div>
    <div class="body">
      <a href="#/shop">BUY PEPTIDES</a>
      <a href="#/learn">ABOUT</a>
      <a href="#/knowledge">KNOWLEDGE</a>
      <a href="#/faq">CONTACT</a>
      <a href="#/account">MY ACCOUNT</a>
    </div>
  </aside>

  <!-- Floating offer -->
  <div class="float-offer" id="offer-tab">15% OFF YOUR FIRST ORDER</div>

  <!-- Cart drawer -->
  <div id="cart-drawer" class="cart-drawer" aria-hidden="true">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <strong>Your Cart</strong>
      <button type="button" id="close-cart" style="border:1px solid var(--line);background:#fff;border-radius:10px;padding:6px 8px;cursor:pointer">Close</button>
    </div>

    <div id="cart-contents"></div>

    <div id="cart-footer" style="margin-top:8px">
      <div class="cart-total" id="cart-total"></div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="checkout-from-cart" class="btn primary" style="flex:1" type="button">Checkout</button>
        <button id="clear-cart" class="btn" style="border:1px solid var(--line);background:#fff" type="button">Clear</button>
      </div>
      <div style="font-size:12px;color:var(--muted);margin-top:8px">Cart checkout creates a single Stripe Checkout session with all items (server must support cart line_items).</div>
    </div>
  </div>

  <main id="app"></main>

  <footer>
    <div class="wrap">
      ¬© <span id="year"></span> Glacier BioLabs ‚Äî Research Use Only ‚Äî Not for human or veterinary use.
    </div>
  </footer>

  <!-- Stripe.js (client) -->
  <script src="https://js.stripe.com/v3/"></script>

  <script>
  // ===== Stripe client setup (no secret key in client) =====
  // Client expects server to expose:
  // GET  /config  -> { publishableKey: 'pk_test_...' }
  // POST /create-checkout-session -> { sessionId: 'cs_...' }
  let stripe = null;
  let stripeReady = false;
  async function loadStripeKey(){
    try {
      const r = await fetch('/config');
      if (!r.ok) return;
      const data = await r.json();
      if (data && data.publishableKey) {
        stripe = Stripe(data.publishableKey);
        stripeReady = true;
      }
    } catch (err) {
      console.warn('Could not load Stripe publishable key:', err);
    }
  }
  loadStripeKey();

  // ===== Images folder setup =====
  const IMAGE_DIR = 'images/';
  const IMAGE_FILES = {
    logo: 'logo.png',
    retatrutide: 'retatrutide-10mg.png',
    ghk: 'ghk-cu-50mg.png',
    mt2: 'mt2-10mg.png',
    bpc: 'bpc-157-10mg.png',
    water: 'bacteriostatic-water-10ml.png',
    coa: 'coa-sample.png'
  };

  // ===== Products (prices in cents) =====
  const PRODUCTS = [
    {
      slug: 'retatrutide',
      name: 'Retatrutide (10 mg)',
      price: 8500,
      category: 'Peptides',
      inStock: true,
      image: IMAGE_FILES.retatrutide,
      short: 'High-purity compound supplied for controlled laboratory research.',
      long: `Retatrutide is supplied as a lyophilized research compound intended exclusively for laboratory, analytical, and scientific investigation. In published literature it has been examined in controlled models related to metabolic signaling pathways. This listing is for research use only (RUO).`,
      sale: true
    },
    {
      slug: 'ghk-cu',
      name: 'GHK-Cu (Copper Peptide) ‚Äì 50 mg',
      price: 4500,
      category: 'Peptides',
      inStock: true,
      image: IMAGE_FILES.ghk,
      short: 'Copper-binding peptide used in research models of skin and tissue biology.',
      long: `GHK-Cu is supplied as a research compound intended for laboratory use only. It is frequently referenced in studies investigating cellular signaling in skin and connective tissue models under controlled experimental conditions.`,
      sale: true
    },
    {
      slug: 'melanotan-ii',
      name: 'Melanotan II (10 mg)',
      price: 4000,
      category: 'Peptides',
      inStock: true,
      image: IMAGE_FILES.mt2,
      short: 'Research analog used to study melanocortin receptor pathways.',
      long: `Melanotan II is supplied as a lyophilized research compound. It is commonly referenced in literature exploring melanocortin receptor signaling pathways in controlled study environments. Research use only.`,
      sale: true
    },
    {
      slug: 'bpc-157',
      name: 'BPC-157 (10 mg)',
      price: 5500,
      category: 'Peptides',
      inStock: true,
      image: IMAGE_FILES.bpc,
      short: 'Peptide fragment used in controlled research models.',
      long: `BPC-157 is provided strictly as a research compound. It appears in literature related to cellular response and signaling in controlled experimental models. Not for human or veterinary use.`,
      sale: false
    },
    {
      slug: 'water',
      name: 'Bacteriostatic Water (10 mL)',
      price: 1000,
      category: 'Supplies',
      inStock: true,
      image: IMAGE_FILES.water,
      short: 'Sterile diluent typically used for laboratory reconstitution workflows.',
      long: `Bacteriostatic water is a sterile solution supplied for laboratory handling and reconstitution workflows. This product is intended strictly for non-clinical laboratory use.`,
      sale: false
    }
  ];

  // ===== Helpers =====
  const PLACEHOLDER = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(
    '<svg xmlns="http://www.w3.org/2000/svg" width="900" height="650"><rect width="100%" height="100%" fill="#ffffff"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#94a3b8" font-family="Arial" font-size="18">Image not available</text></svg>'
  );
  const imgPath = (f) => IMAGE_DIR + f;
  const money = (cents) => '$' + (cents/100).toFixed(2);
  const escapeHtml = (str) => String(str ?? '')
    .replace(/&/g,'&amp;').replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;')
    .replace(/'/g,'&#39;');

  // ===== State for catalog filters/search =====
  const state = {
    q: '',
    inStockOnly: false,
    categories: new Set(),
    minPrice: '',
    maxPrice: '',
    sort: 'default'
  };

  function setActiveNav() {
    const hash = location.hash || '#/';
    document.querySelectorAll('[data-nav]').forEach(a => a.classList.remove('active'));

    if (hash.startsWith('#/shop') || hash === '#/' || hash === '#') {
      const shop = document.querySelector('[data-nav="shop"]');
      if (shop) shop.classList.add('active');
    }
    if (hash.startsWith('#/learn')) {
      const learn = document.querySelector('[data-nav="learn"]');
      if (learn) learn.classList.add('active');
    }
    if (hash.startsWith('#/knowledge')) {
      const k = document.querySelector('[data-nav="knowledge"]');
      if (k) k.classList.add('active');
    }
    if (hash.startsWith('#/faq')) {
      const contact = document.querySelector('[data-nav="contact"]');
      if (contact) contact.classList.add('active');
    }
    // highlight shop when viewing product
    if (hash.startsWith('#/product/')) {
      const shop = document.querySelector('[data-nav="shop"]');
      if (shop) shop.classList.add('active');
    }
  }

  function filterAndSortProducts() {
    let list = PRODUCTS.slice();

    // search
    const q = (state.q || '').trim().toLowerCase();
    if (q) {
      list = list.filter(p => (p.name + ' ' + (p.short||'') + ' ' + (p.category||'')).toLowerCase().includes(q));
    }

    // in stock
    if (state.inStockOnly) list = list.filter(p => p.inStock);

    // categories
    if (state.categories.size > 0) {
      list = list.filter(p => state.categories.has(p.category));
    }

    // price range
    const min = state.minPrice !== '' ? Number(state.minPrice) : null;
    const max = state.maxPrice !== '' ? Number(state.maxPrice) : null;
    if (min != null && !Number.isNaN(min)) list = list.filter(p => p.price >= min*100);
    if (max != null && !Number.isNaN(max)) list = list.filter(p => p.price <= max*100);

    // sort
    if (state.sort === 'price-asc') list.sort((a,b)=>a.price-b.price);
    if (state.sort === 'price-desc') list.sort((a,b)=>b.price-a.price);
    if (state.sort === 'name-asc') list.sort((a,b)=>a.name.localeCompare(b.name));

    return list;
  }

  // ===== Reusable HTML blocks =====
  function productCardHTML(p){
    const img = imgPath(p.image);
    const stockText = p.inStock ? 'In Stock' : 'Out of Stock';
    return `
      <article class="card" data-slug="${escapeHtml(p.slug)}">
        <a href="#/product/${encodeURIComponent(p.slug)}" aria-label="${escapeHtml(p.name)}">
          <div class="img-wrap">
            <div class="img-topbar"></div>
            ${p.sale ? `<div class="tag-sale">SALE</div>` : ``}
            <img src="${escapeHtml(img)}" alt="${escapeHtml(p.name)}" onerror="this.onerror=null;this.src='${PLACEHOLDER}'">
          </div>
        </a>
        <div class="body">
          <h3>${escapeHtml(p.name)}</h3>
          <div class="price">${money(p.price)}</div>
          <div class="small">${escapeHtml(p.short || '')}</div>
          <div class="small" style="text-align:center;margin-top:10px;font-weight:900;color:${p.inStock ? 'var(--accent-2)' : 'var(--muted)'}">${stockText}</div>
          <div class="actions">
            <!-- "ADD" adds to cart -->
            <button class="btn ghost small add-to-cart" data-slug="${escapeHtml(p.slug)}" type="button">ADD</button>
            <!-- "VIEW" goes to the product page where user can add or buy -->
            <a class="btn primary small" href="#/product/${encodeURIComponent(p.slug)}" aria-label="View ${escapeHtml(p.name)}">VIEW</a>
          </div>
        </div>
      </article>
    `;
  }

  function trustSectionHTML(){
    return `
      <section class="trust">
        <div class="wrap">
          <h2>BUY ONLINE ‚Äî QUALITY SECOND TO NONE</h2>
          <div class="trust-grid">
            <div class="trust-card">
              <div class="icon">QC</div>
              <h3>RIGOROUS QUALITY CONTROL</h3>
              <p>Clear labeling, consistent presentation, and research-only positioning.</p>
            </div>
            <div class="trust-card">
              <div class="icon">US</div>
              <h3>SAME DAY SHIPPING (US)</h3>
              <p>Fast fulfillment messaging and mobile-first checkout flow.</p>
            </div>
            <div class="trust-card">
              <div class="icon">24</div>
              <h3>SUPPORT THAT RESPONDS</h3>
              <p>Make your contact + FAQ feel real, not placeholder fluff.</p>
            </div>
          </div>
        </div>
      </section>
    `;
  }

  function bestSellersHTML() {
    return PRODUCTS.slice(0,4).map(p => productCardHTML(p)).join('');
  }

  // ===== Cart (localStorage) =====
  const CART_KEY = 'glacier_cart_v1';
  function readCart(){
    try { return JSON.parse(localStorage.getItem(CART_KEY) || '[]'); }
    catch(e){ return []; }
  }
  function writeCart(cart){ localStorage.setItem(CART_KEY, JSON.stringify(cart)); updateCartUI(); }
  function addToCart(slug, qty = 1){
    const cart = readCart();
    const idx = cart.findIndex(c => c.slug === slug);
    if (idx === -1) cart.push({ slug, qty: qty });
    else cart[idx].qty = (cart[idx].qty || 0) + qty;
    writeCart(cart);
  }
  function removeFromCart(slug){
    const cart = readCart().filter(i => i.slug !== slug);
    writeCart(cart);
  }
  function setQty(slug, qty){
    const cart = readCart();
    const idx = cart.findIndex(c => c.slug === slug);
    if (idx === -1) return;
    cart[idx].qty = Math.max(1, qty);
    writeCart(cart);
  }
  function clearCart(){ writeCart([]); }

  function cartCount(){
    return readCart().reduce((s,i)=>s+(i.qty||0),0);
  }
  function cartTotal(){
    const cart = readCart();
    return cart.reduce((sum, item) => {
      const p = PRODUCTS.find(x => x.slug === item.slug);
      return sum + (p ? p.price * (item.qty || 0) : 0);
    }, 0);
  }

  function updateCartUI(){
    const countEl = document.getElementById('cart-count');
    if (countEl) countEl.textContent = String(cartCount());
    const contents = document.getElementById('cart-contents');
    const total = document.getElementById('cart-total');
    if (!contents || !total) return;
    const cart = readCart();
    if (cart.length === 0){
      contents.innerHTML = '<div class="cart-empty">Your cart is empty.</div>';
      total.textContent = '';
      return;
    }
    contents.innerHTML = cart.map(item => {
      const p = PRODUCTS.find(x=>x.slug===item.slug) || { name: item.slug, price:0 };
      return `<div class="cart-item" data-slug="${escapeHtml(item.slug)}">
        <div class="meta">
          <h4>${escapeHtml(p.name)}</h4>
          <p>${money(p.price)} √ó <input class="qty-input" type="number" min="1" value="${escapeHtml(String(item.qty))}" style="width:60px;padding:6px;border-radius:8px;border:1px solid var(--line)"></p>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
          <div style="font-weight:900">${money((p.price||0)*(item.qty||0))}</div>
          <button class="btn ghost small remove-item" type="button">Remove</button>
        </div>
      </div>`;
    }).join('');
    total.textContent = 'Total: ' + money(cartTotal());
    // wire quantity inputs & remove buttons
    contents.querySelectorAll('.cart-item').forEach(el => {
      const slug = el.getAttribute('data-slug');
      const qtyInput = el.querySelector('.qty-input');
      const removeBtn = el.querySelector('.remove-item');
      if (qtyInput){
        qtyInput.addEventListener('change', () => {
          const val = Number(qtyInput.value || 1);
          if (isNaN(val) || val < 1) { qtyInput.value = '1'; setQty(slug,1); }
          else setQty(slug, Math.floor(val));
        });
      }
      if (removeBtn){
        removeBtn.addEventListener('click', () => removeFromCart(slug));
      }
    });
  }

  // ===== Views =====
  function renderHome(app) {
    app.innerHTML = `
      <section class="hero">
        <div class="wrap">
          <div>
            <div class="kicker">FREE SAME DAY PRIORITY SHIPPING</div>
            <h1>RESEARCH COMPOUNDS</h1>
            <p>Research Use Only ‚Äî Not for human or veterinary use. Built for clean catalog browsing and fast mobile checkout.</p>

            <div class="cta-row">
              <a class="btn primary" href="#/shop">BUY PEPTIDES ONLINE</a>
              <a class="btn ghost" href="#/knowledge">KNOWLEDGE CENTER</a>
            </div>

            <div class="badge">Free US shipping ‚Ä¢ Priority (1‚Äì3 business days) on orders over $199</div>
          </div>

          <div class="panel">
            <strong>Research-first storefront</strong>
            <small>
              Mobile-optimized catalog layout, clean product detail pages, and a consistent red brand system.
              Add your own <code style="color:#fff;opacity:.9">images/hero.jpg</code> later to match the reference even tighter.
            </small>
          </div>
        </div>
      </section>

      <section class="section">
        <div class="wrap">
          <h2>OUR BEST SELLERS</h2>
          <p class="subhead">Clean product cards, consistent spacing, and a layout that looks legit on iPhone.</p>
          <div class="grid">
            ${bestSellersHTML()}
          </div>
        </div>
      </section>

      ${trustSectionHTML()}

      <section class="section">
        <div class="wrap">
          <h2>Shop All Products</h2>
          <p class="subhead">Browse the full catalog with filters and sorting.</p>
          <a class="btn primary" href="#/shop">Open Catalog</a>
        </div>
      </section>
    `;
  }

  function renderShop(app) {
    const categories = Array.from(new Set(PRODUCTS.map(p=>p.category))).sort();
    const filtered = filterAndSortProducts();

    app.innerHTML = `
      <section class="section">
        <div class="wrap">
          <div class="catalog">
            <aside class="filters" aria-label="Filters">
              <div class="filter-block">
                <h3>Price</h3>
                <div class="filter-line"></div>
                <div class="price-range">
                  <input id="minPrice" inputmode="numeric" placeholder="Min" value="${escapeHtml(state.minPrice)}">
                  <input id="maxPrice" inputmode="numeric" placeholder="Max" value="${escapeHtml(state.maxPrice)}">
                  <button id="applyPrice" type="button">Apply</button>
                </div>
              </div>

              <div class="filter-block">
                <h3>Stock</h3>
                <div class="filter-line"></div>
                <label class="check">
                  <input id="inStock" type="checkbox" ${state.inStockOnly ? 'checked' : ''}>
                  In Stock
                </label>
              </div>

              <div class="filter-block">
                <h3>Category</h3>
                <div class="filter-line"></div>
                ${categories.map(cat => `
                  <label class="check">
                    <input class="cat" type="checkbox" value="${escapeHtml(cat)}" ${state.categories.has(cat) ? 'checked' : ''}>
                    ${escapeHtml(cat)}
                    <span class="chip">${PRODUCTS.filter(p=>p.category===cat).length}</span>
                  </label>
                `).join('')}
              </div>
            </aside>

            <div>
              <div class="catalog-head">
                <div class="count">Showing ${filtered.length} result${filtered.length===1?'':'s'}</div>
                <div class="sort">
                  <label class="sr-only" for="sort">Sort</label>
                  <select id="sort">
                    <option value="default" ${state.sort==='default'?'selected':''}>Default sorting</option>
                    <option value="price-asc" ${state.sort==='price-asc'?'selected':''}>Price: low to high</option>
                    <option value="price-desc" ${state.sort==='price-desc'?'selected':''}>Price: high to low</option>
                    <option value="name-asc" ${state.sort==='name-asc'?'selected':''}>Name: A to Z</option>
                  </select>
                </div>
              </div>

              <div class="grid" id="shop-grid">
                ${filtered.map(p=>productCardHTML(p)).join('')}
              </div>
            </div>
          </div>
        </div>
      </section>
    `;

    // wire controls
    const inStock = document.getElementById('inStock');
    if (inStock) {
      inStock.addEventListener('change', () => {
        state.inStockOnly = inStock.checked;
        renderShop(app);
      });
    }

    document.querySelectorAll('.cat').forEach(cb => {
      cb.addEventListener('change', () => {
        const val = cb.value;
        if (cb.checked) state.categories.add(val);
        else state.categories.delete(val);
        renderShop(app);
      });
    });

    const applyPrice = document.getElementById('applyPrice');
    if (applyPrice) {
      applyPrice.addEventListener('click', () => {
        state.minPrice = document.getElementById('minPrice').value.trim();
        state.maxPrice = document.getElementById('maxPrice').value.trim();
        renderShop(app);
      });
    }

    const sort = document.getElementById('sort');
    if (sort) {
      sort.addEventListener('change', () => {
        state.sort = sort.value;
        renderShop(app);
      });
    }

    // wire Add to Cart buttons
    document.querySelectorAll('.add-to-cart').forEach(btn => {
      btn.addEventListener('click', () => {
        const slug = btn.getAttribute('data-slug');
        addToCart(slug, 1);
      });
    });
    // "VIEW" is an anchor to the product page so no JS needed here.
  }

  // ===== Improved product page (replaces previous renderProduct) =====
  function renderProduct(app, slug) {
    const p = PRODUCTS.find(x => x.slug === slug);
    if (!p) {
      app.innerHTML = `
        <section class="section">
          <div class="wrap">
            <div class="page">
              <h1>Product not found</h1>
              <p class="muted">That product doesn‚Äôt exist. Go back to the catalog.</p>
              <a class="btn primary" href="#/shop">Back to shop</a>
            </div>
          </div>
        </section>
      `;
      return;
    }

    app.innerHTML = `
      <section class="section">
        <div class="wrap">
          <div class="crumbs"><a class="backlink" href="#/shop">‚Üê Back to Shop</a></div>

          <div class="product-page">
            <div class="media">
              <div class="img-topbar"></div>
              <img src="${escapeHtml(imgPath(p.image))}" alt="${escapeHtml(p.name)}"
                   onerror="this.onerror=null;this.src='${PLACEHOLDER}'">
            </div>

            <div class="pinfo">
              <h1>${escapeHtml(p.name)}</h1>

              <div class="rating-row">
                <span style="color:var(--accent-2);font-weight:950;">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span>
                <span class="muted">Trusted by researchers</span>
                <span class="muted">‚Ä¢</span>
                <span class="muted">${p.inStock ? 'In Stock' : 'Out of Stock'}</span>
              </div>

              <div class="big-price">${money(p.price)}</div>

              <div class="desc">${escapeHtml(p.long)}</div>

              <div class="ruo">
                RESEARCH USE ONLY ‚Äî Not for human or veterinary use. No medical claims are made.
              </div>

              <form class="form" id="order-form">
                <div class="order-row">
                  <div class="field">
                    <label for="qty">Quantity</label>
                    <select id="qty">
                      <option>1</option><option>2</option><option>3</option><option>4</option>
                    </select>
                  </div>

                  <div class="field">
                    <label for="email">Email</label>
                    <input id="email" type="email" placeholder="you@email.com" required>
                  </div>
                </div>

                <div class="field">
                  <label for="notes">Research Notes (optional)</label>
                  <textarea id="notes" rows="3" placeholder="Optional notes for your order..."></textarea>
                </div>

                <!-- Removed the confirmation checkbox as requested -->

                <div class="cta-bar" style="margin-top:8px">
                  <button class="btn primary full" id="checkout-btn" type="submit" ${p.inStock ? '' : 'disabled'}>BUY NOW ‚Äî ${money(p.price)}</button>
                  <a class="btn" style="border:1px solid var(--line);background:#fff" href="#/shop">Continue Shopping</a>
                </div>

                <p class="order-help" id="order-help">Clicking BUY NOW will redirect you to Stripe Checkout to complete payment.</p>
              </form>
            </div>
          </div>
        </div>
      </section>
    `;

    // wire up interactions: dynamic button label and submit handler
    const form = document.getElementById('order-form');
    const qtyEl = document.getElementById('qty');
    const checkoutBtn = document.getElementById('checkout-btn');

    function updateButtonLabel(){
      const qty = Number(qtyEl.value || 1);
      checkoutBtn.textContent = `${p.inStock ? 'BUY NOW' : 'OUT OF STOCK'} ‚Äî ${money(p.price * qty)}`;
    }

    if (qtyEl) {
      qtyEl.addEventListener('change', updateButtonLabel);
      updateButtonLabel();
    }

    if (form) {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const qty = Number(document.getElementById('qty').value || 1);
        const email = document.getElementById('email').value.trim();
        // confirmation checkbox removed per request
        const notes = document.getElementById('notes').value || '';

        if (!email) {
          alert('Please enter an email for the receipt.');
          return;
        }

        // disable while creating session
        checkoutBtn.disabled = true;
        const prevText = checkoutBtn.textContent;
        checkoutBtn.textContent = 'Preparing checkout...';

        try {
          const resp = await fetch('/create-checkout-session', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
              slug: p.slug,
              qty,
              email,
              notes,
              successUrl: window.location.origin + '/?checkout=success',
              cancelUrl: window.location.href
            })
          });

          const data = await resp.json();
          if (!resp.ok) {
            console.error(data);
            alert(data.message || 'Failed to create checkout session');
            checkoutBtn.disabled = false;
            checkoutBtn.textContent = prevText;
            return;
          }

          const sessionId = data.sessionId;
          if (!sessionId) {
            alert('No session returned from server');
            checkoutBtn.disabled = false;
            checkoutBtn.textContent = prevText;
            return;
          }

          if (!stripeReady) {
            alert('Payment not ready on this site. Ensure server /config is configured.');
            checkoutBtn.disabled = false;
            checkoutBtn.textContent = prevText;
            return;
          }

          const { error } = await stripe.redirectToCheckout({ sessionId });
          if (error) {
            console.error(error);
            alert('Stripe redirect failed: ' + (error.message || 'unknown'));
            checkoutBtn.disabled = false;
            checkoutBtn.textContent = prevText;
          }
        } catch (err) {
          console.error(err);
          alert('Unexpected error creating checkout session');
          checkoutBtn.disabled = false;
          checkoutBtn.textContent = prevText;
        }
      });
    }
  }

  function renderLearn(app) {
    app.innerHTML = `
      <section class="section">
        <div class="wrap">
          <div class="page">
            <h1>About Glacier BioLabs</h1>
            <p>
              Glacier BioLabs is a research-first storefront for laboratory and scientific research materials.
              All products are offered strictly for research use only (RUO) and are not intended for human or veterinary use.
            </p>
            <p>
              Our mission is to support responsible research with consistent presentation, transparent batch handling,
              and a clean browsing experience for customers.
            </p>
            <div class="divider"></div>
            <p class="muted">
              Looking for education content? Visit our <a href="#/knowledge" style="color:var(--accent-2);font-weight:900;">Knowledge Center</a>.
            </p>
          </div>
        </div>
      </section>
    `;
  }

  function renderKnowledge(app) {
    app.innerHTML = `
      <section class="section">
        <div class="wrap">
          <div class="page">
            <h1>Knowledge Center</h1>
            <p>
              This page provides general, non-clinical information about research compounds, testing, and lab handling.
              Content is educational only and not medical advice.
            </p>

            <div class="kcallout">
              RESEARCH USE ONLY ‚Äî Not for human or veterinary use. No medical claims. No dosing or application guidance is provided.
            </div>

            <div class="kgrid">
              <div class="kcard">
                <h3>What Are Research Compounds?</h3>
                <p>
                  Research compounds are substances supplied exclusively for laboratory and scientific investigation.
                  They may be studied in controlled settings to evaluate molecular behavior, stability, and analytical properties.
                </p>
              </div>

              <div class="kcard">
                <h3>Purity & Testing</h3>
                <p>
                  Product quality is commonly verified using analytical methods such as HPLC. Certificates of Analysis (COAs)
                  may be used to confirm identity and purity for a given batch.
                </p>
              </div>

              <div class="kcard">
                <h3>Storage & Handling</h3>
                <p>
                  Proper storage may include temperature-controlled environments, protection from moisture and light,
                  secure containment, and adherence to standard lab safety protocols.
                </p>
              </div>

              <div class="kcard">
                <h3>Compound Education</h3>
                <p>
                  We provide high-level summaries of compounds commonly referenced in scientific literature‚Äîwithout instructions,
                  protocols, or use guidance.
                </p>
                <ul class="klist">
                  <li><strong>BPC-157:</strong> peptide referenced in controlled research models</li>
                  <li><strong>GHK-Cu:</strong> copper-binding peptide studied in biochemical research</li>
                  <li><strong>MT-2:</strong> receptor-binding research analog in controlled settings</li>
                  <li><strong>Retatrutide:</strong> research compound referenced in receptor-focused studies</li>
                </ul>
              </div>
            </div>

            <div class="divider"></div>

            <h2>FAQ</h2>
            <div class="faq">
              <details>
                <summary>Are these products legal?</summary>
                <p>Products are intended for legitimate research purposes. Buyers are responsible for complying with applicable local laws and regulations.</p>
              </details>
              <details>
                <summary>Are COAs available?</summary>
                <p>Yes ‚Äî COAs can be provided upon request for supported batches when available.</p>
              </details>
              <details>
                <summary>Do you provide usage instructions?</summary>
                <p>No. We do not provide dosing, protocols, or application guidance. Products are research use only.</p>
              </details>
            </div>
          </div>
        </div>
      </section>
    `;
  }

  function renderFAQ(app) {
    app.innerHTML = `
      <section class="section">
        <div class="wrap">
          <div class="page">
            <h1>Contact</h1>
            <p>For support, reach us at <strong>support@glacierbiolabs.com</strong>.</p>

            <div class="divider"></div>

            <h2>Frequently Asked Questions</h2>
            <div class="faq">
              <details>
                <summary>What does ‚ÄúResearch Use Only‚Äù mean?</summary>
                <p>Products are sold strictly for laboratory research and analytical purposes. They are not intended for human or veterinary use.</p>
              </details>
              <details>
                <summary>Do you offer refunds?</summary>
                <p>Due to the nature of research materials, all sales are final unless otherwise stated.</p>
              </details>
              <details>
                <summary>How fast is shipping?</summary>
                <p>Shipping times vary by location. Tracking is provided once an order ships.</p>
              </details>
            </div>
          </div>
        </div>
      </section>
    `;
  }

  function renderAccount(app) {
    app.innerHTML = `
      <section class="section">
        <div class="wrap">
          <div class="page">
            <h1>My Account</h1>
            <p class="muted">Account/login is a placeholder right now. Add auth later (Shopify, Supabase, custom, etc.).</p>
          </div>
        </div>
      </section>
    `;
  }

  // ===== Router =====
  function route() {
    const app = document.getElementById('app');
    if (!app) return;

    const hash = location.hash || '#/';
    setActiveNav();

    // Product route: #/product/:slug
    if (hash.startsWith('#/product/')) {
      const slug = decodeURIComponent(hash.split('#/product/')[1] || '');
      renderProduct(app, slug);
      return;
    }

    switch (hash) {
      case '#/':
      case '#':
        renderHome(app);
        break;
      case '#/shop':
        renderShop(app);
        break;
      case '#/learn':
        renderLearn(app);
        break;
      case '#/knowledge':
        renderKnowledge(app);
        break;
      case '#/faq':
        renderFAQ(app);
        break;
      case '#/account':
        renderAccount(app);
        break;
      default:
        // fallback
        location.hash = '#/';
        break;
    }
    updateCartUI();
  }

  // ===== Buy Now (single-item checkout) =====
  async function buyNow(slug, qty = 1){
    if (!stripeReady) {
      alert('Payment system not ready. Ensure server exposes /config with your publishable key.');
      return;
    }
    const email = prompt('Enter your email for receipt:');
    if (!email) { alert('Email required to proceed'); return; }

    try {
      const res = await fetch('/create-checkout-session', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({
          slug, qty, email,
          successUrl: window.location.origin + '/?checkout=success',
          cancelUrl: window.location.href
        })
      });
      const data = await res.json();
      if (!res.ok) {
        console.error('create-checkout-session failed', data);
        alert(data?.message || 'Could not create checkout session');
        return;
      }
      if (!data.sessionId) { alert('No sessionId returned from server'); return; }
      const { error } = await stripe.redirectToCheckout({ sessionId: data.sessionId });
      if (error) {
        console.error(error);
        alert('Stripe redirect failed: ' + (error.message || 'unknown'));
      }
    } catch (err) {
      console.error(err);
      alert('Unexpected error creating checkout session');
    }
  }

  // ===== Cart Checkout (multi-line) =====
  async function checkoutCart(){
    const cart = readCart();
    if (cart.length === 0) { alert('Cart is empty'); return; }
    if (!stripeReady) { alert('Payment system not ready.'); return; }
    const email = prompt('Enter your email for receipt:');
    if (!email) { alert('Email required to proceed'); return; }

    try {
      const res = await fetch('/create-checkout-session', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({
          cart, email,
          successUrl: window.location.origin + '/?checkout=success',
          cancelUrl: window.location.href
        })
      });
      const data = await res.json();
      if (!res.ok) {
        console.error('create-checkout-session failed', data);
        alert(data?.message || 'Could not create checkout session');
        return;
      }
      if (!data.sessionId) { alert('No sessionId returned from server'); return; }
      const { error } = await stripe.redirectToCheckout({ sessionId: data.sessionId });
      if (error) {
        console.error(error);
        alert('Stripe redirect failed: ' + (error.message || 'unknown'));
      }
    } catch (err) {
      console.error(err);
      alert('Unexpected error creating checkout session');
    }
  }

  // ===== UX Wiring =====
  function setupDrawer(){
    const drawer = document.getElementById('drawer');
    const backdrop = document.getElementById('drawer-backdrop');
    const openBtn = document.getElementById('open-drawer');
    const closeBtn = document.getElementById('close-drawer');

    function open(){
      if (!drawer || !backdrop || !openBtn) return;
      drawer.classList.add('open');
      backdrop.style.display = 'block';
      drawer.setAttribute('aria-hidden','false');
      openBtn.setAttribute('aria-expanded','true');
      const c = document.getElementById('close-drawer');
      if (c) c.focus();
    }
    function close(){
      if (!drawer || !backdrop || !openBtn) return;
      drawer.classList.remove('open');
      backdrop.style.display = 'none';
      drawer.setAttribute('aria-hidden','true');
      openBtn.setAttribute('aria-expanded','false');
      openBtn.focus();
    }

    if (openBtn) openBtn.addEventListener('click', open);
    if (closeBtn) closeBtn.addEventListener('click', close);
    if (backdrop) backdrop.addEventListener('click', close);

    if (drawer) {
      drawer.querySelectorAll('a').forEach(a => a.addEventListener('click', close));
    }

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        close();
        closeCart();
      }
    });
  }

  function setupSearch(){
    const form = document.getElementById('search-form');
    const q = document.getElementById('q');
    if (!form || !q) return;

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      state.q = q.value || '';
      location.hash = '#/shop';
      route();
    });
  }

  function setupOfferTab(){
    const tab = document.getElementById('offer-tab');
    if (!tab) return;
    tab.addEventListener('click', () => {
      alert('Offer tab is demo text. Replace with a real promo modal when ready.');
    });
  }

  function setupBrandAssets(){
    const logo = document.getElementById('site-logo');
    if (logo) logo.src = imgPath(IMAGE_FILES.logo);

    const year = document.getElementById('year');
    if (year) year.textContent = String(new Date().getFullYear());
  }

  // Cart drawer helpers
  function openCart(){ const cartDrawer = document.getElementById('cart-drawer'); if (cartDrawer) { cartDrawer.classList.add('open'); cartDrawer.setAttribute('aria-hidden','false'); updateCartUI(); } }
  function closeCart(){ const cartDrawer = document.getElementById('cart-drawer'); if (cartDrawer) { cartDrawer.classList.remove('open'); cartDrawer.setAttribute('aria-hidden','true'); } }

  // ===== Boot =====
  window.addEventListener('hashchange', route);

  document.addEventListener('DOMContentLoaded', () => {
    setupDrawer();
    setupSearch();
    setupOfferTab();
    setupBrandAssets();

    // cart UI wiring
    const cartToggle = document.getElementById('cart-toggle');
    const closeCartBtn = document.getElementById('close-cart');
    const clearBtn = document.getElementById('clear-cart');
    const checkoutFromCart = document.getElementById('checkout-from-cart');

    if (cartToggle) cartToggle.addEventListener('click', () => { updateCartUI(); openCart(); });
    if (closeCartBtn) closeCartBtn.addEventListener('click', () => closeCart());
    if (clearBtn) clearBtn.addEventListener('click', () => { if (confirm('Clear cart?')) clearCart(); });
    if (checkoutFromCart) checkoutFromCart.addEventListener('click', () => checkoutCart());

    // click handler for dynamically created add-to-cart buttons (global delegation fallback)
    document.body.addEventListener('click', (e) => {
      const addBtn = e.target.closest && e.target.closest('.add-to-cart');
      if (addBtn) {
        const slug = addBtn.getAttribute('data-slug');
        addToCart(slug, 1);
      }
    });

    // Default route
    if (!location.hash) location.hash = '#/';
    route();
  });
  </script>
</body>
</html>